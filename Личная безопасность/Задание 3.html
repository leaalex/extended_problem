<style>

    .msg-class.success-false{
        background: red;
        color:white;
    }

    .msg-class.success-true{
        background: green;
    }

    .msg-class{
        background: #e2e2e2;
        /*font-size: 130%;*/
        border: 1px solid;
        padding: 8px;
        margin: 8px 0px;
        max-width: 800px;
        cursor: pointer;
    }

    .choice-container{
        margin: 10px 0px;
        /*font-size: 130%;*/
    }
    .choice-container button{
        padding: 5px;
        margin: 8px;
        font-size: 90%;
        cursor: pointer;
    }


</style>
<div id="text">

</div>



<script type="text/javascript">


    let messages = {
        msg_1: {
            type: "choice",
            text: "Ноябрь.Городской двор. Ты приехал к другу на день рождения на своем автомобиле. Припарковал автомобиль на стоянке. У тебя в руках чехол с удочками (друг заядлый рыбак). Отошел от него на расстояние 30 метров, двигаясь к дому, в котором живет друг. Услышал злобный лай собаки. Это немецкая овчарка, вес около 15 кг.Она быстро приближается к тебе. Какие твои действия? ",
            choices: [
                {
                    text: "Стоя лицом к собаке, постепенно начинаю продвигаться к машине",
                    next_id: "msg_2"
                },
                {
                    text: "Повернусь к собаке лицом",
                    next_id: "msg_3"
                },
                {
                    text: "Я точно оценил, что успею добежать до подъезда друга, и побегу в подъезд",
                    next_id: "msg_8"
                },
                {
                    text: "Начну звонить другу по мобильному телефону",
                    next_id: "msg_17"
                }
            ],
        },
        msg_2:{
            type: "choice",
            text: "Вы подошли близко к машине. Что дальше?",
            choices: [
                {
                    text: "Открываю машину и сажусь в нее спиной - лицом по направлению к собаке",
                    next_id: "msg_19"
                },
                {
                    text: "Залезаю в машину лицом вперед, чтобы сделать это максимально быстро",
                    next_id: "msg_20",
                },
            ]
        },
        msg_3: {
            type: "choice",
            text: "Собака оскалила зубы. Смотрит на вас. Ваши действия?",
            choices: [
                {
                    text: "Быстро осмотрюсь вокруг себя.",
                    next_id: "msg_4"
                },
                {
                    text: "Буду так же пристально смотреть на собаку. Не спущу глаз с ее действий\n",
                    next_id: "msg_5"
                },
            ]
        },
        msg_4:{
            type: "choice",
            text: "Отлично! Около вас на земле лежит большой камень. А в руках есть удочка. Что будете делать дальше?",
            choices: [
                {
                    text: "Двумя руками крепко возьму чехол с удочками, выставлю как защиту перед собой. ",
                    next_id: "msg_6"
                },
                {
                    text: "Быстро возьму камень с земли и брошу в собаку. Громко угрожающе буду кричать и махать руками",
                    next_id: "msg_7"
                },
                {
                    text: "Я не буду поднимать камень с земли, он очень большой и тяжелый. Я имитирую, что поднимаю камень с земли",
                    next_id: "msg_18"
                },
                {
                    text: "Буду так же пристально смотреть на собаку. Не спущу глаз с ее действий\n",
                    next_id: "msg_5"
                },
            ]
        },
        msg_5:{
            type: "choice",
            text: "Тоже вариант! Тогда вы не увидите, есть ли вокруг вас какие-то вспомогательные предметы. Что будете делать дальше?",
            choices: [
                {
                    text: "Имитирую, что поднимаю что-то с земли",
                    next_id: "msg_18"
                }
            ]
        },
        msg_6:{
            type: "choice",
            text: "Уже хорошо. Что дальше?",
            choices: [
                {
                    text: "Постепенно и уверенно начну продвигаться к подъезду, в котором живет мой друг",
                    next_id: "msg_22",
                }
            ]
        },
        msg_7:{
            type: "text",
            text: "Собака отступила. Вы молодец!",
            final: true,
            success: true,
        },
        msg_8:{
            type: "choice",
            text: "Вы добежали до подъезда. Дверь закрыта  ",
            choices: [
                {
                    text: "Я позвоню по домофону в квартиру друга",
                    next_id: "msg_9"
                },
                {
                    text: "Я дерну дверь за ручку",
                    next_id: "msg_10"
                },
            ]
        },
        msg_9:{
            type: "choice",
            text: "Собака напала на вас со спины, и друг вам ответил в домофон. Как вы будете действовать?",
            choices: [
                {
                    text: "Я нанесу удары собаке чехлом с удочками",
                    next_id: "msg_11"
                },
                {
                    text: "Я громко прокричу имя друга и  «Помоги!»",
                    next_id: "msg_12"
                },
            ]
        },
        msg_10:{
            type: "choice",
            text: "Собака приближается. Дверь не поддалась. Что делаете дальше?",
            choices: [
                {
                    text: "Я позвоню по домофону в квартиру друга",
                    next_id: "msg_9"
                },
                {
                    text: "Я еще раз дерну дверь за ручку",
                    next_id: "msg_13"
                },
            ]
        },
        msg_11:{
            type: "text",
            text: "Обороняйтесь предметами, которые есть под рукой. Прокричите в домофон имя друга и \"Помоги\". Друг придет на помощь.",
            final: true,
            success: false,
        },
        msg_12:{
            type: "text",
            text: "Скорее всего друг успеет прийти на помощь. Пока он идет к вам, отбивайтесь от собаки подручными средствами - удочкой,  камнями с земли ",
            final: true,
            success: false,
        },
        msg_13:{
            type: "choice",
            text: "Дверь опять не поддалась. Собака приближается. Что делаете дальше?",
            choices: [
                {
                    text: "Я позвоню по домофону в квартиру друга",
                    next_id: "msg_15"
                },
                {
                    text: "Я еще раз дерну дверь за ручку",
                    next_id: "msg_14"
                },

            ]
        },
        msg_14:{
            type: "text",
            text: "Успех! Дверь поддалась. Вы спасены",
            final: true,
            success: true,
        },
        msg_15:{
            type: "choice",
            text: "Вы не успеваете набрать номер квартиры на домофоне. Вы потеряли очень много времени на попытки открыть закрытую дверь. Собака напала на вас. Как вы будете действовать?",
            choices: [
                {
                    text: "Активно отбиваюсь всеми возможными способами и подручными средствами. ",
                    next_id: "msg_21"
                },
                {
                    text: "Падаю. Группируюсь в позе эмбриона: прижимаю голову к груди, поджимаю к животу колени, закрываю руками голову",
                    next_id: "msg_16"
                },
            ]
        },
        msg_16:{
            type: "text",
            text: "Самое неправильное в драке с собакой – это страх перед ней и пассивная оборона ( упасть, закрыть голову руками и т.д.) – в этом случае ты точно пострадаешь и сильнее, нежели активно обороняясь. Когда ты лежишь на земле, собака чувствует свое превосходство над тобой",
            final: true,
            success: false,
        },
        msg_17:{
            type: "choice",
            text: "Плохой вариант. Скорее всего вы не успеете даже  ему ответить. Собака на тебя напала. Предположи, как ты будешь действовать дальше",
            choices: [
                {
                    text: "Быстро осмотрюсь вокруг себя.",
                    next_id: "msg_4"
                },
                {
                    text: "Падаю. Группируюсь в позе эмбриона: прижимаю голову к груди, поджимаю к животу колени, закрываю руками голову",
                    next_id: "msg_16"
                },
            ]
        },
        msg_18:{
            type: "text",
            text: "Хороший ход! Добавьте к этому громкий крик и широко размахивайте руками, имитируя бросание предмета в сторону собаки. Собака отступила. Вы молодец!",
            final: true,
            success: true,
        },
        msg_19:{
            type: "text",
            text: "Молодец! Бежать, поворачиваться спиной к собаке нельзя. Она всегда окажется быстрее и догонит. А как только ты повернешься к ней спиной, нападет.",
            final: true,
            success: true,
        },
        msg_20:{
            type: "choice",
            text: "Эх, это было опасно. Бежать, поворачиваться спиной к собаке нельзя. Она всегда окажется быстрее и догонит. Собака напала на вас. Ваши действия?",
            choices: [
                {
                    text: "Активно отбиваюсь всеми возможными способами и подручными средствами.",
                    next_id: "msg_21"
                },
                {
                    text: "Падаю. Группируюсь в позе эмбриона: прижимаю голову к груди, поджимаю к животу колени, закрываю руками голову",
                    next_id: "msg_16"
                },
            ]
        },
        msg_21:{
            type: "text",
            text: "У вас однозначно есть шанс спугнуть собаку. Издавайте громкие звуки. Покажите ей, что вы сильны",
            final: true,
            success: true,
        },
        msg_22:{
            type: "choice",
            text: "Отлично! Около вас на земле лежит большой камень. А в руках есть удочка. Что будете делать дальше?",
            choices: [
                {
                    text: "Быстро возьму камень с земли и брошу в собаку. Громко угрожающе буду кричать и махать руками",
                    next_id: "msg_7"
                },
                {
                    text: "Я не буду поднимать камень с земли, он очень большой и тяжелый. Я имитирую, что поднимаю камень с земли",
                    next_id: "msg_18"
                },
            ]
        },
    };

    function createElement(name, id, classList, attributes) {
        let element = document.createElement(name);
        if (id) element.id = id;
        if (classList) element.classList = classList;
        if (attributes) {
            for (let attr in attributes) {
                element.setAttribute(attr, attributes[attr])
            }
        }
        return element;
    }

    function Choice(msg_id, id, choice, html_element) {
        this.id = id;
        this.next_id = choice.next_id;
        this.text = choice.text;
        this.comment = choice.comment;
        this.html = createElement('button', '', '', {type: "radio", value: id, name: "before_" + this.next_id});
        this.html.innerHTML = this.text;

        this.html.onclick = function () {
            if (Message.curr_msg_id == msg_id){
                Message.curr_msg_id = this.next_id;
                if(this.comment){
                    new Message(undefined, {type: "comment", text: this.comment.text, comment: this.comment, next_id: this.next_id}, html_element);
                }else{
                    new Message(this.next_id, messages[this.next_id], html_element);
                }
            }
        }.bind(this);
    }

    function Message(id, settings, html_element) {
        console.log(settings)
        var id = id;
        this.id = id;
        this.type = settings.type || "text";
        this.final = settings.final || false;
        this.text = settings.text;
        this.next_id = this.final ? undefined : settings.next_id;
        this.show_delay = settings.show_delay || 1000;
        this.comment = settings.comment || undefined;


        Object.defineProperty(this, "is_choice", {
            get: function() {
                return this.type === 'choice';
            }
        });
        Object.defineProperty(this, "is_text", {
            get: function() {
                return this.type === 'text';
            }
        });
        Object.defineProperty(this, "is_comment", {
            get: function() {
                return this.type === 'comment';
            }
        });

        let success_class = (settings.success !== undefined) ? "success-" + settings.success: "";
        if (settings.choices) {
            this.choices = settings.choices.map(function (ch, index) {

                // console.log(ch)

                return new Choice(id, id + "_choice_" + index, ch, html_element)
            })
        }

        this.html = createElement('div', id, 'msg-class '+ this.type + ' ' + success_class, {});
        this.html.innerHTML = this.text;

        html_element.append(this.html);

        if(this.is_choice){
            let choice_container = createElement('div', null, 'choice-container', {})
            this.choices.forEach(function (item) {
                choice_container.append(item.html)
            });
            this.html.append(choice_container);

        }
        else if(this.is_text){
            if (!this.final) {
                this.html.onclick = function () {
                    if (Message.curr_msg_id != this.next_id) {
                        Message.curr_msg_id = this.next_id;
                        new Message(this.next_id, messages[this.next_id], html_element);
                    }
                }.bind(this);
            }
        }
        else if (this.is_comment){
            // console.log("KEK", this)
            new Message(this.next_id, messages[this.next_id], html_element);
        }
        else{}

    }

    function Task(html_element, messages, things_list, ){



        let first_msg_id = "msg_1";
        // Message.curr_msg_id = first_msg_id;

        this.html_element = html_element;

        new Message(first_msg_id, messages[first_msg_id], html_element);
    }



    /*
        Message types:
            - text
            - choice
            - comment

       Comment tunes:
            - "good"
            - "bad"
            - "neutral"

       Финал может быть:
            - положительным
            - отрицательным
            - нейтральным может быть?



     */



    let task = new Task(document.querySelector("#text"));
    // task.start();


</script>
