<style>

    .msg-class.success-false{
        background: red;
        color:white;
    }

    .msg-class.success-true{
        background: green;
    }

    .msg-class{
        background: #e2e2e2;
        /*font-size: 130%;*/
        border: 1px solid;
        padding: 8px;
        margin: 8px 0px;
        max-width: 800px;
        cursor: pointer;
    }

    .choice-container{
        margin: 10px 0px;
        /*font-size: 130%;*/
    }
    .choice-container button{
        padding: 5px;
        margin: 8px;
        font-size: 90%;
        cursor: pointer;
    }


</style>
<div id="text">

</div>



<script type="text/javascript">



    let messages = {
        msg_1: {
            type: "choice",
            text: "Избегаю толпы",
            choices: [
                {
                    text: "Смочу шарф  жидкостью из бутылки. Приложу его к лицу. ",
                    next_id: "msg_2"
                },
                {
                    text: "Вижу туалет. Захожу в него",
                    next_id: "msg_4"
                },
                {
                    text: "Навстречу мне идет толпа. Я не хочу попасть в ее поток, поэтому иду против течения толпы",
                    next_id: "msg_"
                },
                {
                    text: "Иду к лифту. Быстро спущусь на первый этаж и выйду из опасного места",
                    next_id: "msg_"
                }
            ],
        },
        msg_2: {
            type: "text",
            text: "Иду к тому выходу, куда идет немного людей.  Я ведь хорошо знаю всё в этом торговом центре!",
            next_id: "msg_3",
        },
        msg_3: {
            type: "text",
            text: "Ура! Я спасен!",
            final: true,
            success: true,
        },
        msg_4: {
            type: "choice",
            text:">> Захожу в туалет... <<",
            choices: [
                {
                    text: "Повесил куртку на ручку  с обратной стороны двери туалета",
                    next_id: "msg_5"
                },
                {
                    text: "Быстро зашел в туалет и плотно закрыл за собой дверь. ",
                    next_id: "msg_12"
                }
            ]
        },
        msg_5: {
            type: "choice",
            text: ">> Я в туалете! <<",
            choices: [
                {
                    text: "Смочу свитер водой. Положу его на пол, закрыв щель между полом и дверью",
                    next_id: "msg_6"
                },{
                    text: "Позвоню в службу спасения 112. сообщу о случившемся и о том, где я нахожусь ",
                    next_id: "msg_11"
                }
            ]
        },
        msg_6: {
            type: "choice",
            text: "Позвоню в службу спасения 112. сообщу о случившемся и о том, где я нахожусь ",
            choices: [
                {
                    text: "Открою окно, чтобы спрыгнуть вниз",
                    next_id: "msg_7"
                },{
                    text: "Открою окно, чтобы было больше воздуха",
                    next_id: "msg_13"
                },{
                    text: "Открыл водопроводные краны. Регулярно смачиваю одежду и шарф, через который дышу",
                    next_id: "msg_15"
                }
            ]
        },
        msg_7: {
            type: "choice",
            text: ">> Как прыгать будем? Сальто? <<",
            choices: [
                {
                    text: "Прыгаю в панике, не удается скоординировать действия",
                    next_id: "msg_8"
                },{
                    text: "Прыгаю сгруппировавшись",
                    next_id: "msg_10"
                }
            ]
        },
        msg_8: {
            type: "text",
            text: "Множественные переломы рук и ног, ушибы",
            next_id: "msg_9"
        },
        msg_9: {
            type: "text",
            text: "Ура! Я  ранен, но главное - выжил!",
            final: true,
            success: true
        },
        msg_10: {
            type: "text",
            text: "Ура! Мы спасены! >> Кто мы то? Он один здесь<<",
            final: true,
            success: true
        },
        msg_11: {
            type: "text",
            text: "Пока разговариваю надышался угарным газом. Потерял сознание",
            final: true,
            success: false
        },
        msg_12: {
            type: "choice",
            text: ">> Я в таулете. Что делаем дальше? <<",
            choices: [
                {
                    text: "Позвоню в службу спасения 112. сообщу о случившемся и о том, где я нахожусь ",
                    next_id: "msg_11"
                },{
                    text: "Открою окно, чтобы было больше воздуха",
                    next_id: "msg_13"
                },{
                    text: "Открыл водопроводные краны. Регулярно смачиваю одежду и шарф, через который дышу",
                    next_id: "msg_15"
                }
            ]
        },
        msg_13: {
            type: "text",
            text: "Создалась тяга воздуха. В туалет стал поступать дым. ",
            next_id: "msg_14"
        },
        msg_14: {
            type: "text",
            text: "Надышался угарным  газом. Потерял сознание",
            final: true,
            success: false
        },
        msg_15: {
            type: "text",
            text: "Лег на пол. Там больше кислорода",
            next_id: "msg_16"
        },
        msg_16: {
            type: "text",
            text: "Сохраняю спокойствие.",
            next_id: "msg_17"
        },
        msg_17: {
            type: "text",
            text: "Я молодец! Благополучно переждал (а) опасность!",
            final: true,
            success: true
        },
        msg_18: {

        },
        msg_19: {

        },
        msg_20: {

        },
        msg_21: {

        },
        msg_22: {

        },
        msg_23: {

        },

    }


    function createElement(name, id, classList, attributes) {
        let element = document.createElement(name);
        if (id) element.id = id;
        if (classList) element.classList = classList;
        if (attributes) {
            for (let attr in attributes) {
                element.setAttribute(attr, attributes[attr])
            }
        }
        return element;
    }

    function Choice(msg_id, id, choice, html_element) {
        this.id = id;
        this.next_id = choice.next_id;
        this.text = choice.text;
        this.html = createElement('button', '', '', {type: "radio", value: id, name: "before_" + this.next_id});
        this.html.innerHTML = this.text;

        this.html.onclick = function () {
            if (Message.curr_msg_id == msg_id){
                Message.curr_msg_id = this.next_id;
                new Message(this.next_id, messages[this.next_id], html_element);
            }
        }.bind(this);
    }

    function Message(id, settings, html_element) {
        var id = id;
        this.id = id;
        this.type = settings.type || "text";
        this.final = settings.final || false;
        this.text = settings.text;
        this.next_id = this.final ? undefined : settings.next_id;
        this.show_delay = settings.show_delay || 1000;
        this.comment = settings.comment || undefined;


        Object.defineProperty(this, "is_choice", {
            get: function() {
                return this.type === 'choice';
            }
        });
        Object.defineProperty(this, "is_text", {
            get: function() {
                return this.type === 'text';
            }
        });

        let success_class = (settings.success !== undefined) ? "success-"+settings.success: "";
        if (settings.choices) {
            this.choices = settings.choices.map(function (ch, index) {
                return new Choice(id, id + "_choice_" + index, ch, html_element)
            })
        }

        this.html = createElement('div', id, 'msg-class '+ this.type + ' ' + success_class, {});
        this.html.innerHTML = this.text;

        if(this.is_choice){
            let choice_container = createElement('div', null, 'choice-container', {})
            this.choices.forEach(function (item) {
                choice_container.append(item.html)
            });
            this.html.append(choice_container);

        }
        else if(this.is_text){
            if (!this.final) {
                this.html.onclick = function () {
                    if (Message.curr_msg_id != this.next_id) {
                        Message.curr_msg_id = this.next_id;
                        new Message(this.next_id, messages[this.next_id], html_element);
                    }
                }.bind(this);
            }
        }
        else{}
        html_element.append(this.html);
    }

    function Task(html_element){
        let first_msg_id = "msg_1";
        Message.curr_msg_id = first_msg_id;

        this.html_element = html_element;
        new Message(first_msg_id, messages[first_msg_id], html_element);
    }


    /*
        Message types:
            - text
            - choice
            - comment


       Comment tunes:
            - "good"
            - "bad"
            - "neutral"

     */





    let task = new Task(document.querySelector("#text"));
    // task.start();


</script>
