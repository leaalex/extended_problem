<problem>

	<style type="text/css">

		/*
        //
            !!! SORTABLE TABLE CSS !!!
            !!! START !!!
        //
        */
		.conf-table {
			width: 100%;
		}

		.arrow-td {
			font-size: 2em;
			text-align: center !important;
			padding: 4px !important;
		}

		.arrow-td i {
			-webkit-text-stroke: 4px white;
		}

		td.text-td:first-child::after {
			content: "";
			vertical-align: top;
			min-height: 50px;
		}

		.text-td {
			height: 50px;
			border: 2px solid #bfbfc1;
			padding: 0px !important;
		}

		.text-td .conf-item {
			text-align: center;
		}

		.text-td .conf-item {
			height: 100%;
			min-width: auto;
		}

		.conf-item {
			max-height: 50px;
			word-break: initial;
			vertical-align: middle;
			background: #f3f3f3;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 31%;
			/*max-width: 31%;*/
			text-align: center;
			cursor: move;
			min-width: auto;
		}

		.conf-item {
			border: 1px solid #b2b2b2;
		}

		.fixed-item{
			word-break: initial;
			vertical-align: middle;
			background: #ffffff;
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
			text-align: center;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		.conf-table .conf-item {
			width: 100%;
			border: none;
			margin: 0px;
			max-height: 100%;
		}

		#conf-id {
			display: flex;
			flex-wrap: wrap;
			background: #f5f5f580;
			min-height: 120px;
		}

		#conf-id .conf-item {
			max-height: 50px;
			margin: 2px;
		}

		/*
        //
            !!! END !!!
        //
        */

		.organizers-input-wrap input{
			margin-top: -1px !important;
			vertical-align: middle !important;
		}

		.incorrect-element-message{
			display: none;
			background: #ffffff;
			width: fit-content;
			padding: 10px;
			margin: 10px 0px;
			/*display: block;*/
			border-radius: 4px;
			border: 2px solid red;
		}

		.question-input-wrap input{
			margin-top: -1px;
			margin-right: 4px;
			vertical-align: middle;
		}

		.question-input-wrap label{
			font-size: 1em;
			cursor: pointer;
		}

		.question-input-wrap{
			padding: 10px 10px;
			margin: 6px 0px;
			border: 2px solid #e5e5e5;
			border-radius: 3px;
			cursor: pointer;
		}

		.question-input-wrap img {
			max-width: 500px;
		}

		.question-input-wrap.correct-answer, .question-input-wrap.correct-answer:hover {
			border: 2px solid #009b01;
		}

		.question-input-wrap.incorrect-answer, .question-input-wrap.incorrect-answer:hover{
			border: 2px solid #cb0711;
		}

		.question-input-wrap:hover{
			border: 2px solid #009fe6;
		}

		.question-wrap{
			margin: 6px 0px;
			padding: 10px;
		}

		.used-attemps{
			margin-top: 30px;
		}

		.correctness-status.incorrect::after {
			font-family: FontAwesome;
			content: "\f00d";
			color: #cb0712;
			display: block;
			text-align: center;
			margin: 6px 0px;
			font-size: 2.5em;
		}

		.correctness-status.correct::after {
			font-family: FontAwesome;
			content: "\f00c";
			color: #009b00;
			display: block;
			text-align: center;
			margin: 6px 0px;
			font-size: 2.5em;
		}

		#math_input_wrap input {
			border-radius: 2px !important;
		}

		#math_input_wrap.correct input {
			border: 2px solid #009b00;
		}

		#math_input_wrap.incorrect input {
			border: 2px solid #cb0712;
		}

		#math_input_wrap.correct::after {
			font-family: FontAwesome;
			content: "\f00c";
			color: #009b00;
			text-align: center;
			margin: 0px 8px;
			font-size: 1.5em;
			vertical-align: -20%;
		}

		#math_input_wrap.incorrect::after {
			font-family: FontAwesome;
			content: "\f00d";
			color: #cb0712;
			text-align: center;
			margin: 0px 8px;
			font-size: 1.5em;
			vertical-align: -20%;
		}

		#text_task_MathOutput{
			background: #f2f2f2;
			width: fit-content;
			padding: 7px;
			margin: 10px 0px;
			border-radius: 4px;
		}

		.highligth-correct-answer{
			margin: 20px 0px;
			padding: 10px;
			border-radius: 6px;
			/* background: #f1ffff; */
			border: 2px solid #d4d4de;
		}

		.highligth-correct-answer p {
			margin: 10px 0px !important;
		}

		.highligth-correct-answer p span {
			/*text-transform: lowercase;*/
		}

		.highligth-correct-answer ul {
			margin: 8px .75em !important;
		}

		.highligth-correct-answer ul li {
			margin-bottom: 0.3em !important;
		}

		#visual_organizer_task_input{
			display: none !important;
		}

		#vizual_organizer_explanation{
			display: none;
			margin: 20px 0px;
			padding: 10px;
			border-radius: 6px;
			background: #f5f5f566;
		}

	</style>

	<script type="loncapa/python">
import math
import json

organizers_btn_label = "Выбрать анализатор"
elements_btn_label = "Выбрать элемент"
check_btn_label = "Проверить"
next_btn_label = "Дальше"

max_element_attemps = 3
max_step_3_1_attemps = 3
minus_3_1_attemps = 1

max_step_3_2_attemps = 3

p_label = "р"

unique_id = "task_djkjvfds42v"

incorrect_elements = {
	"venn_diagram" : {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Диаграмма Венна не может быть применена для определения правильности решения Мардж.",
		#"comment": "venn_diagram comment",
	}, 
	"web_charts": {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Веб диаграмма не может быть применена для определения правильности решения Мардж, поскольку выборка недостаточно репрезентативна.",
		#"comment": "web_charts comment",
	}, 
	"force_field_analysis": {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Анализ силовых полей не может быть применен для определения правильности решения Мардж, поскольку исход событий практически равновероятен на каждом шаге.",
		#"comment": "force_field_analysis comment",
	},
	"estimated_space": {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Оценочное пространство не может быть применено для определения правильности решения Мардж, поскольку вероятность события не связана с оценочными суждениями.",
		#"comment": "estimated_space comment",
	},
	"concept_cards": {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Концептуальные карты не могут быть применены для определения правильности решения Мардж, поскольку данный инструментарий позволяет более эффективно находить причину события, а не его вероятность.",
		#"comment": "concept_cards comment",
	},
	"planning_cards": {
		"comment": "Вы выбрали неверный инструмент визуального организатора. Планирующие карты не могут быть применены для определения правильности решения Мардж, поскольку данный инструментарий позволяет более эффективно ставить цели, достижение которых минимальным образом зависит от случайных факторов.",
		#"comment": "planning_cards comment",
	}
}

correct_answers_3 = {
  "inductive_towers": {
    "step_3_1": {
      "answer": {"a1": ["b1"], "a2": ["b2"], "a3": ["b3"], "a4": ["b4"], "a5": ["b5"], "a6": ["b6"], "a7": ["b7"], "a8": ["b8"], "a9": ["b9"], "a10": ["b10"]},
      "correct_answer": {"img": "/static/inductive_towers_correct_b26aol.png"}
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "b",
      "question_3": [
        "b",
        "c",
        "e"
      ]
    }
  },
  "charts": {
    "step_3_1": {
      "answer": "a",
      "correct_answer": "a"
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "a",
      "question_3": [
        "b",
        "d"
      ]
    }
  },
  "drawings_and_matrixes": {
    "step_3_1": {
        "answer": ['1', 'p1', 'p2', 'p3'],
        "correct_answer": "Формула: p1 + p2 + p3 = 1 (p_1 + p_2 + p_3 = 1)"
    },
    "step_3_2": {
      "question_1": "b",
      "question_2": "b",
      "question_3": [
        "a"
      ]
    }
  },
  "pie_chart": {
    "step_3_1": {
        "answer": "b",
        "correct_answer": "b"
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "a",
      "question_3": [
        "b",
        "d"
      ]
    }
  },
  "pie_charts": {
    "step_3_1": {
        	"answer": "c",
          "correct_answer": "c"
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "a",
      "question_3": [
        "b",
        "d"
      ]
    }
  },
  "causal_card_chains": {
    "step_3_1": {
      "answer": {"a1": ["b1"], "a2": ["b2"], "a3": ["b3"], "a4": ["b4"], "a5": ["b5"]},
      "correct_answer": {"img": "/static/causal_card_chains_kd52ob.png"}
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "a",
      "question_3": [
        "b",
        "d"
      ]
    }
  },
  "current_cards": {
    "step_3_1": {
      "answer": {"a1": ["b1"], "a2": ["b2"], "a3": ["b3"], "a4": ["b4"], "a5": ["b5"], "a6": ["b6"]},
      "correct_answer": {"img": "/static/current_cards_correct_u8qqgs.png"}
    },
    "step_3_2": {
      "question_1": "c",
      "question_2": "a",
      "question_3": [
        "b",
        "d"
      ]
    }
  }
}

def check_table(CA, SA):
    grade = 0
    max_grade = len(CA.keys())
    response = {"correctness": False}
    for key in CA.keys():
        if (set(CA[key]) == set(SA[key])):
            grade = grade + 1
    if grade == max_grade:
        response["correctness"] = True
    return response

def check_text(CA, SA):
    student_answer = sorted(SA.replace("_", "").replace(" ", "").replace("+", " ").replace("=", " ").split(" "))
    response = {"correctness": False}
    if CA == student_answer:
        response["correctness"] = True
    return response

def check_choice(CA, SA):
    response = {"correctness": False}
    if CA == SA:
        response["correctness"] = True
    return response

def check_step_3_1(SA):
    correctness = False
    resp = {}
    if SA["step_3_1"]["check_type"] == "table":
        resp = check_table(correct_answers_3[SA["element"]["name"]]["step_3_1"]["answer"], SA["step_3_1"]["answer"])
        if SA["step_3_1"]["attemps"] == max_step_3_1_attemps:
            resp["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_1"]["correct_answer"]
    elif SA["step_3_1"]["check_type"] == "text":
        resp = check_text(correct_answers_3[SA["element"]["name"]]["step_3_1"]["answer"], SA["step_3_1"]["answer"])
        if SA["step_3_1"]["attemps"] == max_step_3_1_attemps:
            resp["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_1"]["correct_answer"]
    elif SA["step_3_1"]["check_type"] == "choice":
        resp = check_choice(correct_answers_3[SA["element"]["name"]]["step_3_1"]["answer"], SA["step_3_1"]["answer"])
        if SA["step_3_1"]["attemps"] == max_step_3_1_attemps-minus_3_1_attemps:
            resp["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_1"]["correct_answer"]
    else:
        resp = {"correctness": False}
    return resp

def check_step_3_2(SA):
    response = {
      "question_1": {
        "correctness": False
      },
      "question_2": {
        "correctness": False
      },
      "question_3": {
        "correctness": False,
        "user_correct": []
      }
    }
    if SA["step_3_2"]["answer"]["question_1"] == correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_1"]:
        response["question_1"]["correctness"] = True
    if SA["step_3_2"]["answer"]["question_2"] == correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_2"]:
        response["question_2"]["correctness"] = True
    if sorted(SA["step_3_2"]["answer"]["question_3"]) == sorted(correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_3"]):
        response["question_3"]["correctness"] = True
        response["question_3"]["user_correct"] = SA["step_3_2"]["answer"]["question_3"]
    else:
        for ans in SA["step_3_2"]["answer"]["question_3"]:
            if ans in correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_3"]:
                response["question_3"]["user_correct"].append(ans)
    if SA["step_3_2"]["attemps"] == max_step_3_2_attemps:
        response["question_1"]["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_1"]
        response["question_2"]["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_2"]
        response["question_3"]["correct_answer"] = correct_answers_3[SA["element"]["name"]]["step_3_2"]["question_3"]

    return response

def check_answer(expect, ans):
    max_grade = 6
    student_answer = json.loads(ans)
    student_answer = student_answer["answer"]
    step = int(student_answer["step"])
    grade = 0
    response = {}
    if step == 2:
        if student_answer["element"]["name"] in incorrect_elements.keys():
            response["element_correctness"] = {
                "correctness": False,
                "comment": incorrect_elements[student_answer["element"]["name"]]["comment"]
            }
        else:
            response["element_correctness"] = {
                "correctness": True, 
                "comment": ""
            }
        if int(student_answer["element_attemps"]) >= 3:
           response["element_correctness"] = {
               "correctness": False,
               "comment": "Превышено максимальное количество попыток!"
           }
    if step == 3:
        response["step_3_1"] = check_step_3_1(student_answer)
        if response["step_3_1"]["correctness"] == True:
            grade += 3
    if step == 4:
        response["step_3_1"] = check_step_3_1(student_answer)
        if response["step_3_1"]["correctness"] == True:
            grade += 3
        if student_answer["step_3_2"]["send_type"] == "check":
            response["step_3_2"] = check_step_3_2(student_answer)
            if response["step_3_2"]["question_1"]["correctness"] == True:
                grade += 1
            if response["step_3_2"]["question_2"]["correctness"] == True:
                grade += 1
            if response["step_3_2"]["question_3"]["correctness"] == True:
                grade += 1
    else:
        pass
    grade_decimal = grade/max_grade
    
    if grade_decimal == 1:
        status = True
    elif grade_decimal == 0:
        status = False
    else:
        status = 'Partial'

    return {'input_list': [{'ok': status, 'msg': json.dumps(response), 'grade_decimal': grade_decimal}, ]}
</script>

	<meta charset="UTF-8" />
	<script type="text/javascript" charset="utf-8">
		$(window).unbind('scroll');

		var organizers_btn_label = "$organizers_btn_label"
		var elements_btn_label = "$elements_btn_label"
		var check_btn_label = "$check_btn_label"
		var next_btn_label = "$next_btn_label"

		var max_element_attemps = parseInt("$max_element_attemps");
		var max_step_3_1_attemps = parseInt("$max_step_3_1_attemps");
		var max_step_3_2_attemps = parseInt("$max_step_3_2_attemps");
		var minus_3_1_attemps = parseInt("$minus_3_1_attemps");

		function Answer(elementField) {
			this.elementField = elementField;
			this.fieldValue = "";
			this.fieldObject = {};
			this.get = function() {
				this.fieldValue = elementField.value;
				return this.fieldValue;
			};
			this.set = function(value) {
				if (value == undefined) value = this.fieldValue;
				elementField.value = value;
			};
			this.getJSON = function() {
				if (this.isJsonString(this.get())) this.fieldObject = JSON.parse(this.get());
				return this.fieldObject;
			};
			this.setJSON = function(object) {
				if (object == undefined) object = this.fieldObject;
				this.set(JSON.stringify(object))
			};
			this.isJsonString = function(str) {
				try {
					JSON.parse(str);
				} catch (e) {
					return false;
				}
				return true;
			};
		};

		(function () {
			window.TextTaskUpdateMath = function (TeX) {
				TeX = "\\(" + TeX + "\\)";
				TeX = TeX.replace(/i(\w)/g, "\\overline{"+ "$1" + "}")
				document.getElementById("text_task_MathOutput").innerHTML = TeX;
				MathJax.Hub.Queue(["Typeset", MathJax.Hub,"text_task_MathOutput"]);
			}
		})();

		$(window).load(function(){
			// $.scrollTo.window().stop(true);
			$([document.documentElement, document.body]).animate({
				scrollTop: $("#visual_organizer").offset().top
			}, 500);
		});

		$.fn.shuffleChildren = function() {
			$.each(this.get(), function(index, el) {
				var $el = $(el);
				var $find = $el.children();

				$find.sort(function() {
					return 0.5 - Math.random();
				});

				$el.empty();
				$find.appendTo($el);
			});
		};

		// var notification = $(".problem .notification.notification-submit").hide();
		$("#visual_organizer").closest(".problem").find(".notification.notification-submit").hide()

		var submit_button = $("#visual_organizer").closest(".problem").find('button.submit');
		$(submit_button).css('text-transform','none');


		function enableSubmitButton(){
			$(submit_button).removeClass("disabled");
			$(submit_button).removeAttr("disabled");
		}

		function setSubmitText(text){
			$(submit_button).find('span.submit-label').text(text);
		}

		var task_tables = {
			"inductive_towers":
					`<div class="step-task-wording"><p><strong>Задание:</strong> Вам необходимо восстановить логику Мардж с помощью выбранного инструмента и сделать вывод, насколько данный инструмент подходит для решения подобной задачи.</p></div>
  <table id="inductive_towers_table" class="conf-table" style="font-size: 0.9em;">
      <tbody>
         <tr>
            <td colspan="4" class="text-td conf-answers-place" style="width: 40%" id="a1">
               
            </td>
            <td class="arrow-td"><i class="fa fa-arrow-right"></i></td>
            <td class="text-td conf-answers-place" id="a2" style="width: 25%">
               
            </td>
            <td class="arrow-td"><i class="fa fa-arrow-left"></i></td>
            <td colspan="2" class="text-td conf-answers-place" style="width: 26%" id="a3"></td>
         </tr>
         <tr>
            <td colspan="4" class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td colspan="3" rowspan="4"></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
         </tr>
         <tr>
            <td colspan="4" class="text-td conf-answers-place" id="a4"></td>
            <td class="text-td conf-answers-place" id="a5"></td>
            <td class="text-td"><div class="fixed-item">Очень редко</div></td>
         </tr>
         <tr>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
            <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
         </tr>
         <tr>
            <td class="text-td conf-answers-place" id="a6" style="width: 10%;"></td>
            <td class="text-td conf-answers-place" id="a7" style="width: 10%;"></td>
            <td class="text-td" style="width: 10%;"><div class="fixed-item">Выпадает на одно и то же поле 3 раза</div></td>
            <td class="text-td conf-answers-place" id="a8" style="width: 10%;"></td>
            <td class="text-td conf-answers-place" id="a9" style="width: 13%"></td>
            <td class="text-td conf-answers-place" id="a10" style="width: 13%"></td>
         </tr>
      </tbody>
   </table> 

   <div id="conf-id" class="conf-answers-place conf-all-answers">
      <div class="conf-item" id="b1">Вероятность выпадения высокая</div>
      <div class="conf-item" id="b2">Ставка на другой цвет после 5 попаданий позволит выиграть</div>
      <div class="conf-item" id="b3">Вероятность выпадения низкая</div>
      <div class="conf-item" id="b4">часто</div>
      <div class="conf-item" id="b5">редко</div>
      <div class="conf-item" id="b6">Выпадает на одно и то же поле 1 раз</div>
      <div class="conf-item" id="b7">Выпадает на одно и то же поле 2 раза</div>
      <div class="conf-item" id="b8">Выпадает на одно и то же поле 4 раза</div>
      <div class="conf-item" id="b9">Выпадает на одно и то же поле 5 раз</div>
      <div class="conf-item" id="b10">Выпадает на одно и то же поле 6 раз</div>
   </div>`,
			"causal_card_chains":
					`<div class="step-task-wording"><p><strong>Задание:</strong> Вам необходимо восстановить логику Мардж с помощью выбранного инструмента и сделать вывод, насколько данный инструмент подходит для решения подобной задачи.</p></div>
   <table id="causal_card_chains_table" class="conf-table">
      <tbody>
         <tr>
            <td class="text-td conf-answers-place" id="a1">
               
            </td>
         </tr>
         <tr>
            <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>   
         </tr>
         <tr>
            <td class="text-td conf-answers-place" id="a2">
               
            </td>
         </tr>
         <tr>
            <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
         </tr>
         <tr>
            <td class="text-td conf-answers-place" id="a3">
               
            </td>
         </tr>
         <tr>
            <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
         </tr>
         <tr>
            <td class="text-td conf-answers-place" id="a4">
               
            </td>
         </tr>
         <tr>
            <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
         </tr>
         <tr>
            <td class="text-td conf-answers-place" id="a5">
               
            </td>
         </tr>
      </tbody>
   </table>

   <div id="conf-id" class="conf-answers-place conf-all-answers">
      <div class="conf-item" id="b1">Поход в казино</div>
      <div class="conf-item" id="b2">Наблюдение за рулеткой</div>
      <div class="conf-item" id="b3">Выявление закономерности</div>
      <div class="conf-item" id="b4">Оценка вероятности и рисков</div>
      <div class="conf-item" id="b5">Решение сделать ставку</div>
   </div> `,
			"current_cards":
					`<div class="step-task-wording"><p><strong>Задание:</strong> Вам необходимо восстановить логику Мардж с помощью выбранного инструмента и сделать вывод, насколько данный инструмент подходит для решения подобной задачи.</p></div>
   <table id="current_cards_table" class="conf-table">
   <tbody>
      <tr>
         <td colspan="3"  class="text-td conf-answers-place" id="a1" style="width: 32%;">
            
         </td>
         <td class="arrow-td"><i class="fa fa-arrow-right"></i></td>
         <td  class="text-td conf-answers-place" id="a2" style="width: 22%;">
            
         </td>
         <td class="arrow-td"><i class="fa fa-arrow-right"></i></td>
         <td  class="text-td conf-answers-place" id="a3" style="width: 24%;">
            
         </td>
         <td class="arrow-td"><i class="fa fa-arrow-right"></i></td>
         <td  class="text-td conf-answers-place" id="a4" style="width: 26%;">
            
         </td>
      </tr>
      <tr>
         <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
         <td rowspan="3"></td>
         <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
         <td colspan="5" rowspan="4"></td>
         <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
      </tr>
      <tr>
      
         <td  class="text-td" style="width: 15%;">
            <div class="fixed-item">Не ставить</div>
         </td>
         <td  class="text-td conf-answers-place" id="a5" style="width: 15%;">
            
         </td>
         <td  class="text-td">
        <div class="fixed-item">Ставка на красное</div>
         </td>
      </tr>
      <tr>
         <td class="arrow-td"><i class="fa fa-arrow-up"></i></td>
         <td class="arrow-td"><i class="fa fa-arrow-down"></i></td>
         <td></td>
      </tr>
      <tr>
         <td colspan="3"  class="text-td conf-answers-place" id="a6">
            
         </td>
         <td></td>
      </tr>
   	</tbody>
	</table>

	<div id="conf-id" class="conf-answers-place conf-all-answers">
	      <div class="conf-item" id="b1">Первый бросок шарика</div>
	      <div class="conf-item" id="b2">Выпал на черное</div>
	      <div class="conf-item" id="b3">Выпал на черное 2-4 раза</div>
	      <div class="conf-item" id="b4">Выпал на черное 5 раз</div>
	      <div class="conf-item" id="b5">Выпал на красное</div>
	      <div class="conf-item" id="b6">Выпал на зеленое</div>
	</div> `
		}

		var all_questions = {
			"inductive_towers": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Ставка на другой цвет после 5 попаданий не позволит выигрывать чаще, чем проигрывать."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да"
						},
						{
							"let": "b",
							"text": "Нет"
						},
						{
							"let": "c",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Ошибка Мардж связана с мышлением и не вызвана каким-то сбоем в реальном мире"
						},
						{
							"let": "c",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "d",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "e",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			},
			"charts": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Ставка на другой цвет после 5 попаданий не позволит выигрывать чаще, чем проигрывать."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да"
						},
						{
							"let": "b",
							"text": "Нет"
						},
						{
							"let": "c",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "c",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "d",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			},
			"drawings_and_matrixes": {
				"question_1": {
					"question_wording": "Использовала ли Мардж данную формулу?",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да"
						},
						{
							"let": "b",
							"text": "Нет"
						},
						{
							"let": "c",
							"text": "Иногда"
						}
					]
				},
				"question_2": {
					"question_wording": "Достаточно ли данной формулы для построения матрицы распределения вероятности?",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да"
						},
						{
							"let": "b",
							"text": "Нет"
						},
						{
							"let": "c",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Какой величины не достаточно для построения матрицы и вычисления точной вероятности возможного выигрыша?",
					"answer_choices": [
						{
							"let": "a",
							"text": "Плотности перехода"
						},
						{
							"let": "b",
							"text": "Рассеянности перехода"
						},
						{
							"let": "c",
							"text": "Продолжительности наблюдения"
						}
					]
				}
			},
			"pie_chart": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Ставка на другой цвет после 5 попаданий не позволит выигрывать чаще, чем проигрывать."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да, при длительном наблюдении"
						},
						{
							"let": "b",
							"text": "Да, всегда"
						},
						{
							"let": "c",
							"text": "Нет"
						},
						{
							"let": "d",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "c",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "d",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			},
			"pie_charts": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Ставка на другой цвет после 5 попаданий не позволит выигрывать чаще, чем проигрывать."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да, при длительном наблюдении"
						},
						{
							"let": "b",
							"text": "Да, всегда"
						},
						{
							"let": "c",
							"text": "Нет"
						},
						{
							"let": "d",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "c",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "d",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			},
			"causal_card_chains": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Мардж не нужно ходить в казино. Казино выигрывает чаще."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да, при правильной оценки вероятности"
						},
						{
							"let": "b",
							"text": "Да, всегда"
						},
						{
							"let": "c",
							"text": "Нет"
						},
						{
							"let": "d",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "c",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "d",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			},
			"current_cards": {
				"question_1": {
					"question_wording": "Вывод, который можно сделать по данной схеме:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Надо ставить на черное, если шарик 5 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "b",
							"text": "Надо ставить на черное, если шарик 6 раз выпал на красное. Это поможет чаще выигрывать, чем проигрывать."
						},
						{
							"let": "c",
							"text": "Мардж пытается снизить вероятность проигрыша."
						}
					]
				},
				"question_2": {
					"question_wording": "Подходит ли данный инструмент для Мардж:",
					"answer_choices": [
						{
							"let": "a",
							"text": "Да, при правильной оценки вероятности"
						},
						{
							"let": "b",
							"text": "Да, всегда"
						},
						{
							"let": "c",
							"text": "Нет"
						},
						{
							"let": "d",
							"text": "Иногда"
						}
					]
				},
				"question_3": {
					"question_wording": "Оценив условия мысленного эксперимента и визуального организатора, какой вывод можно сделать:",
					"answer_choices": [
						{
							"let": "a",
							"text": "У Мардж все отлично с логикой"
						},
						{
							"let": "b",
							"text": "Мардж посчитала реальным то, что не было подтверждено ее наблюдениями"
						},
						{
							"let": "c",
							"text": "Мардж будет очень богатой очень скоро"
						},
						{
							"let": "d",
							"text": "Мардж – плохой экспериментатор"
						}
					]
				}
			}
		}

		var questions_3_1 = {
			"charts": {
				"question_wording": "Укажите изображение с верным порядком вероятностей в зависимости от количества бросков.",
				"answer_choices": [
					{
						"let": "a",
						"text": '<img src="/static/charts_03_01_img_01.png" />'
					},
					{
						"let": "b",
						"text": '<img src="/static/charts_03_01_img_02.png" />'
					},
					{
						"let": "c",
						"text": '<img src="/static/charts_03_01_img_03.png" />'
					}
				]
			},
			"pie_chart": {
				"question_wording": "Укажите изображение с верным порядком вероятностей в зависимости от количества бросков.",
				"answer_choices": [
					{
						"let": "a",
						"text": '<img src="/static/pie_chart_03_01_img_02.png" />'
					},
					{
						"let": "b",
						"text": '<img src="/static/pie_chart_03_01_img_01.png" />'
					},
					{
						"let": "c",
						"text": '<img src="/static/pie_chart_03_01_img_03.png" />'
					}
				]
			},
			"pie_charts": {
				"question_wording": "Укажите изображение с верным порядком вероятностей в зависимости от количества бросков и номера серии.",
				"answer_choices": [
					{
						"let": "a",
						"text": '<img src="/static/pie_charts_03_01_img_03.png" />'
					},
					{
						"let": "b",
						"text": '<img src="/static/pie_charts_03_01_img_02.png" />'
					},
					{
						"let": "c",
						"text": '<img src="/static/pie_charts_03_01_img_01.png" />'
					}
				]
			}
		}

		var answer = new Answer(document.querySelector("#visual_organizer").querySelector("input[type='text']"));

		var organizers = {
			ground_to_top: {
				name: "ground_to_top",
				title: "«С земли – к вершине»",
			},
			birds_flight_to_ground: {
				name: "birds_flight_to_ground",
				title: "«С птичьего полета – к земле»",
			},
		}

		var organizer_elements = {
			inductive_towers: {
				organizer: organizers.ground_to_top,
				title: "Индуктивные башни",
				name: "inductive_towers",
			},
			charts: {
				organizer: organizers.ground_to_top,
				title: "Графики",
				name: "charts",
			},
			drawings_and_matrixes: {
				organizer: organizers.ground_to_top,
				title: "Чертежи и матрицы",
				name: "drawings_and_matrixes"
			},
			venn_diagram: {
				organizer: organizers.ground_to_top,
				title: "Диаграмма Венна",
				name: "venn_diagram",
			},
			pie_chart: {
				organizer: organizers.ground_to_top,
				title: "Диаграмма «Пирог»",
				name: "pie_chart",
			},
			pie_charts: {
				organizer: organizers.ground_to_top,
				title: "Круговые диаграммы",
				name: "pie_charts",
			},
			web_charts: {
				organizer: organizers.ground_to_top,
				title: "Веб-диаграммы",
				name: "web_charts",
			},
			causal_card_chains: {
				organizer: organizers.birds_flight_to_ground,
				title: "Причинные цепочки-карты",
				name: "causal_card_chains",
			},
			planning_cards: {
				organizer: organizers.birds_flight_to_ground,
				title: "Планирующие карты",
				name: "planning_cards",
			},
			force_field_analysis: {
				organizer: organizers.birds_flight_to_ground,
				title: "Анализ силовых полей",
				name: "force_field_analysis",
			},
			estimated_space: {
				organizer: organizers.birds_flight_to_ground,
				title: "Оценочное пространство",
				name: "estimated_space",
			},
			concept_cards: {
				organizer: organizers.birds_flight_to_ground,
				title: "Концептуальные карты",
				name: "concept_cards",
			},
			current_cards: {
				organizer: organizers.birds_flight_to_ground,
				title: "Текущие карты",
				name: "current_cards",
			}
		}

		function getElementsByOrganizer(org){
			var output_list = [];
			var tmp_org = org;
			if (typeof org == 'string'){
				tmp_org = tmp_org;
			}
			else{
				tmp_org = org.name;
			}
			output_list = Object.keys(organizer_elements).filter(function(elem){ return organizer_elements[elem].organizer.name == tmp_org }).map(function(mapped){return organizer_elements[mapped]});
			return output_list;
		}

		var user_state = new Object();
		user_state.step = 1;
		user_state.organizer = organizers[Object.keys(organizers)[0]];
		user_state.element = getElementsByOrganizer(user_state.organizer)[0];
		user_state.element_attemps = 0;
		user_state.step_3_1 = {
			check_type: "",
			answer:{},
			attemps: 0
		}
		user_state.step_3_2 = {
			answer: {
				question_1: "",
				question_2: "",
				question_3: [],
			},
			attemps: 0,
			send_type: "next"
		}


		if(answer.get()){

			user_state = answer.getJSON()["answer"];
			var response = JSON.parse($("#visual_organizer_task_input .message").html());

			if (user_state.step == 1){
				user_state.step = 2;
			}

			if(user_state.step == 2){
				user_state.response = response;
				if (user_state.response["element_correctness"]){
					user_state.element_attemps += 1;
					if (user_state.response["element_correctness"]["correctness"] == true){
						user_state.step = 3;
						createStep3_1();
					}
					else{
						createChoiceOrganizerElement(true);
					}
				}
				else{
					createChoiceOrganizerElement();
				}
			}

			else if(user_state.step == 3){
				user_state.response = response;
				createStep3_1();
			}
			else if(user_state.step == 4){
				user_state.response = response;
				createStep3_2();
			}
			else{
				console.log("Unhandled step");
			}
		}
		else{
			createChoiceOrganizer();
		}

		function createChoiceOrganizerElement(show_error=false){
			$("#visual_organizer_task").append("<h2>" + "Шаг 2. " + "</h2>");
			var choice_elements_wrap = $("<div/>", {
				class: "",
				html: "<p>Выберите наиболее предпочтительный элемент визуального организатора " + user_state.organizer.title + " </p>"
			});
			var incorrect_element_message = $("<div/>", {
				class: "incorrect-element-message"
			});
			// ;
			getElementsByOrganizer(user_state.organizer).forEach(function(element, index) {
				var input_wrap = $("<div/>", {
					class: "organizers-input-wrap",
				});
				var input = $("<input/>", {
					type: "radio",
					id: element.name + "Choice",
					value: element.name,
					name: "elementChoice"
				});
				var label = $("<label/>", {
					for: element.name + "Choice",
					html: "  " + element.title,
				});
				$(input).change(function() {
					var element_choiced = $("input[name='elementChoice']:checked").val();
					user_state.element = organizer_elements[element_choiced];
					incorrect_element_message.hide();
					answer.setJSON({answer: user_state});
				});

				input_wrap.append(input);
				input_wrap.append(label);
				choice_elements_wrap.append(input_wrap);
			});

			$("#visual_organizer_task").append(choice_elements_wrap);
			$("#" + user_state.element.name + "Choice").prop('checked', true);


			$("#visual_organizer_task").append(incorrect_element_message);

			if (show_error){
				// $("#visual_organizer_task").append('<div class="incorrect-element-message">' + user_state.response["element_correctness"]["comment"]+ " </div>");
				incorrect_element_message.html(user_state.response["element_correctness"]["comment"]);
				incorrect_element_message.show()
				if (user_state.element_attemps == max_element_attemps){
					$("input[name='elementChoice']").attr('disabled', 'disabled');
					$(submit_button).hide();
				}
			}
			$("#visual_organizer_task").append('<div class="used-attemps">Использовано попыток ' + user_state.element_attemps + " из " + max_element_attemps + "</div>");
			setSubmitText(elements_btn_label);
			answer.setJSON({answer: user_state});
		}

		function createChoiceOrganizer(){
			$("#visual_organizer_task").append("<h2>" + "Шаг 1. " + "</h2>");
			var choice_organizer_wrap = $("<div/>", {
				class: "",
				html: "<p>Выберите из списка наиболее подходящий визуальный анализатор: </p>"
			});
			Object.keys(organizers).forEach(function(element, index) {
				var input_wrap = $("<div/>", {
					class: "organizers-input-wrap",
				});
				var input = $("<input/>", {
					type: "radio",
					id: element + "Choice",
					value: element,
					name: "organizerChoice"
				});
				if (index == 0 ) input.attr('checked', 'checked');
				var label = $("<label/>", {
					for: element + "Choice",
					html: "  " + organizers[element].title,
				});
				$(input).change(function() {
					var organizer_choiced = $("input[name='organizerChoice']:checked").val();
					user_state.organizer = organizers[organizer_choiced];
					user_state.element = getElementsByOrganizer(user_state.organizer)[0];
					answer.setJSON({answer: user_state});
				});

				input_wrap.append(input);
				input_wrap.append(label);
				choice_organizer_wrap.append(input_wrap);
			});
			$("#visual_organizer_task").append(choice_organizer_wrap);
			setSubmitText(organizers_btn_label);
			// user_state.step += 1;
			answer.setJSON({answer: user_state});
		}

		function createStep3_1(){
			$("#visual_organizer_task").append("<h2> Шаг 3.1. "  + user_state.element.title + "</h2>");
			answer.setJSON({answer: user_state});

			if( ["inductive_towers", "causal_card_chains", "current_cards"].includes(user_state.element.name)){
				createTableTask(user_state.element.name);
			}
			else if (["drawings_and_matrixes"].includes(user_state.element.name)){
				createTextTask(user_state.element.name);
			}
			else if (["charts", "pie_chart", "pie_charts"].includes(user_state.element.name)){
				createChoiceTask(user_state.element.name);
			}
			else{
				console.log("Undefined element!")
			}
		}

		function createTableTask(name){
			setSubmitText(check_btn_label);
			user_state.step_3_1.check_type = "table";
			var html = task_tables[name];
			var wrap = $("<div/>", {
				id:"table_task",
				html: html
			});

			$("#visual_organizer_task").append(wrap);

			var element = $("#table_task");

			$("#conf-id", element).shuffleChildren();

			var student_build_answer = user_state.step_3_1.answer;

			if (Object.keys(student_build_answer).length != 0){
				for (key in student_build_answer) {
					for ( l in student_build_answer[key]) {
						$("#" + key, element).append($("#" + student_build_answer[key][l], element));
					}
				}
			}

			var correctness_status = $("<div/>", {
				class: "correctness-status"
			}).appendTo($("#visual_organizer_task"));

			setAnswer();
			answer.setJSON({answer: user_state});

			$(".conf-answers-place",element).sortable({
				connectWith: "#" + "table_task" + " .conf-answers-place",
				cursorAt: {  },
				cursor: "move",
				start: function(event, ui) {
					ui.item.css('width', 'fit-content')
					ui.item.css('min-width', '300px');
					ui.item.css('max-width', '400px');
					ui.item.css('height', 'auto');
					correctness_status.removeClass('correct');
					correctness_status.removeClass('incorrect');
					$(".conf-answers-place", element).sortable( "option", "cursorAt", { left: ui.item.width() / 2, top: ui.item.height() / 2 } );
				},
				stop: function(event, ui) {
					ui.item.css('max-width', 'inherit');
					ui.item.css('min-width', 'auto');
					setAnswer();
				},
				sort: function() {

				},
				opacity: 0.8,
				over: function(event) {
					$("#" + event.target.id, element).css("border","2px dashed #b2b2b2");
				},
				out: function(event) {
					$("#" + event.target.id, element).css("border","");
				},
				receive: function(event, ui) {
					// so if > 10
					if($(this).attr('id') !== 'conf-id'){
						if ($(this).children().length == 2) {
							$(ui.sender).sortable('cancel');
						}
					}
				},
			}).disableSelection();


			function setAnswer(){
				var student_answer = {};
				$(".conf-table td.conf-answers-place", element).map(function(indx, item){
					item_id = $(item).attr("id");
					student_answer[item_id] = $(item).find(".conf-item").map(function(index, sub_item){
						return $(sub_item).attr("id")
					}).get();
				}).get();
				user_state.step_3_1.answer = student_answer;
				answer.setJSON({answer: user_state});
			}

			$("#visual_organizer_task").append('<div class="used-attemps">Использовано попыток ' + user_state.step_3_1.attemps + " из " + max_step_3_1_attemps + "</div>");
			if (user_state.response["step_3_1"]){
				if(user_state.step_3_1.attemps == max_step_3_1_attemps){
					setSubmitText(next_btn_label);
					$(".conf-answers-place",element).sortable("disable");
					user_state.step = 4;
					if(user_state.response["step_3_1"]["correctness"] == false){
						var correct_answer = $("<div/>",{
							class: "highligth-correct-answer",
						});
						correct_answer.append("<h2>Правильный ответ:</h2>");

						var correct_image_wrap = $("<div/>",{
							style: "text-align: center;",
						});
						var correct_image = $("<img/>", {
							src: user_state.response["step_3_1"]["correct_answer"]["img"]
						}).appendTo(correct_image_wrap);

						correct_answer.append(correct_image_wrap)

						$("#visual_organizer_task").append(correct_answer);
					}
					// All attempts used. Show correct answer
				}
				else{
					user_state.step_3_1.attemps += 1;
				}
				if (user_state.response["step_3_1"]["correctness"] == true){
					setSubmitText(next_btn_label);
					correctness_status.addClass("correct");
					$(".conf-answers-place",element).sortable("disable");
					user_state.step = 4;
					// show correctness "True"
				}
				else{
					correctness_status.addClass("incorrect");
					// show correctness "False"
				}
			}
			else{
				user_state.step_3_1.attemps += 1;
			}
			answer.setJSON({answer: user_state});
		}

		function createTextTask(name){
			setSubmitText(check_btn_label);
			user_state.step_3_1.check_type = "text";
			// var html = task_tables[name];
			var wrap = $("<div/>", {
				id:"text_task",
			});

			wrap.append("<p>Задание: Если \\(p_1\\) – вероятность выпадения на черное, \\(p_2\\) – вероятность выпадения на красное, \\(p_3\\) – вероятность выпадения на зеленое поле. Напишите формулу, связывающую все три вероятности.</p>")

			if (typeof  user_state.step_3_1.answer === 'object'){
				user_state.step_3_1.answer = "";
			}

			var input_wrap = $("<div/>", {
				class: "",
				id: "math_input_wrap"
			})

			var input = $("<input/>", {
				type: "text",
				id:"text_task_MathInput"
			}).appendTo(input_wrap);

			wrap.append(input_wrap)

			var output = $("<div/>", {
				id:"text_task_MathOutput"
			}).appendTo(wrap);


			$(input).on('input', function() {
				TextTaskUpdateMath($(this).val());
				input_wrap.removeClass('correct');
				input_wrap.removeClass('incorrect');
				user_state.step_3_1.answer = $(this).val();
				answer.setJSON({answer: user_state});
			});

			$("#visual_organizer_task").append(wrap);
			$("#visual_organizer_task").append('<div class="used-attemps">Использовано попыток ' + user_state.step_3_1.attemps + " из " + max_step_3_1_attemps + "</div>");


			if (user_state.response["step_3_1"]){
				$(input).val(user_state.step_3_1.answer);
				TextTaskUpdateMath(user_state.step_3_1.answer);
				if(user_state.step_3_1.attemps == max_step_3_1_attemps){
					setSubmitText(next_btn_label);
					$(input).attr('disabled', 'disabled');
					user_state.step = 4;

					if(user_state.response["step_3_1"]["correctness"] == false){
						var correct_answer = $("<div/>",{
							class: "highligth-correct-answer",
						});
						correct_answer.append("<h2>Правильный ответ:</h2>");
						correct_answer.append("<p>" + user_state.response["step_3_1"]["correct_answer"] + "</p>");
						$("#visual_organizer_task").append(correct_answer);
					}
					// All attempts used. Show correct answer
				}
				else{
					user_state.step_3_1.attemps += 1;
				}
				if (user_state.response["step_3_1"]["correctness"] == true){
					setSubmitText(next_btn_label);
					input_wrap.addClass("correct");
					$(input).attr('disabled', 'disabled');
					user_state.step = 4;
					// show correctness "True"
				}
				else{
					input_wrap.addClass("incorrect");
					// show correctness "False"
				}
			}
			else{
				user_state.step_3_1.attemps += 1;
			}
			answer.setJSON({answer: user_state});
		}

		function createChoiceTask(name){
			$(submit_button).attr("disabled", "disabled");
			$(submit_button).addClass("disabled");
			setSubmitText(check_btn_label);
			user_state.step_3_1.check_type = "choice";

			var current_question = questions_3_1[name];

			var question_text = $("<div/>", {
				class: "question-text",
				html: current_question["question_wording"]
			});

			var inputs_block = $("<div/>", {
				class: "inputs-block"
			});

			current_question["answer_choices"].forEach(function(element, index) {
				var input_wrap = $("<div/>", {
					class: "question-input-wrap"
				});
				var input = $("<input/>",{
					type: "radio",
					name: "question_choice",
					value: element["let"],
				});
				input_wrap.append(input);
				input_wrap.append(element["text"]);
				inputs_block.append(input_wrap);
				input_wrap.click(function(e) {
					$('input', $(e.delegateTarget)).prop('checked', true);
					var val = $("input[name='question_choice']:checked").val();
					$(".question-input-wrap",inputs_block).removeClass("incorrect-answer");
					user_state.step_3_1.answer = val;
					answer.setJSON({answer: user_state});
					enableSubmitButton();
				});
			});

			$("#visual_organizer_task").append(question_text);
			$("#visual_organizer_task").append(inputs_block);

			$("#visual_organizer_task").append('<div class="used-attemps">Использовано попыток ' + user_state.step_3_1.attemps + " из " + (max_step_3_1_attemps-minus_3_1_attemps) + "</div>");

			if (user_state.response["step_3_1"]){
				var selected_input = $("input[value=" + user_state.step_3_1.answer + "]" , inputs_block);
				$("input[value=" + user_state.step_3_1.answer + "]", inputs_block).prop('checked', true);
				enableSubmitButton();
				if(user_state.step_3_1.attemps == (max_step_3_1_attemps-minus_3_1_attemps)){
					setSubmitText(next_btn_label);
					user_state.step = 4;
					$(".question-input-wrap input").prop('disabled', true);
					$(".question-input-wrap").unbind( "click" )
					$(".question-input-wrap").css('cursor', 'not-allowed');
					// All attempts used. Show correct answer
					if(user_state.response["step_3_1"]["correctness"] == false){
						var correct_answer = $("<div/>",{
							class: "highligth-correct-answer",
						});
						correct_answer.append("<h2>Правильный ответ:</h2>");

						var correct_image_wrap = $("<div/>",{
							style: "text-align: center;",
						});
						var correct_image = $("<img/>", {
							// src: user_state.response["step_3_1"]["correct_answer"]["img"]
							src: $("input[value=" + user_state.response["step_3_1"]["correct_answer"] + "]" , inputs_block).closest(".question-input-wrap").find("img").attr("src")
						}).appendTo(correct_image_wrap);

						correct_answer.append(correct_image_wrap)

						$("#visual_organizer_task").append(correct_answer);
					}

				}
				else{
					user_state.step_3_1.attemps += 1;
				}
				if (user_state.response["step_3_1"]["correctness"] == true){
					setSubmitText(next_btn_label);
					user_state.step = 4;
					$(".question-input-wrap input").prop('disabled', true);
					$(".question-input-wrap").unbind( "click" )
					$(".question-input-wrap").css('cursor', 'not-allowed');
					selected_input.closest('.question-input-wrap').addClass("correct-answer");
					// show correctness "True"
				}
				else{
					selected_input.closest('.question-input-wrap').addClass("incorrect-answer");
					// show correctness "False"
				}
			}
			else{
				user_state.step_3_1.attemps += 1;
			}
			answer.setJSON({answer: user_state});
		}

		function createStep3_2(){
			setSubmitText(check_btn_label);
			$(submit_button).attr("disabled", "disabled");
			$(submit_button).addClass("disabled");
			user_state.step_3_2.send_type = "check";
			$("#visual_organizer_task").append("<h2> Шаг 3.2. "  + user_state.element.title + "</h2>");
			answer.setJSON({answer: user_state});
			var questions_wrap = $('<div/>', {});
			var question_1_wrap = $('<div/>',{
				class: "question-wrap"
			});
			question_1_wrap.append("<p> 1. " + all_questions[user_state.element.name]["question_1"]["question_wording"] + "</p>");
			var question_2_wrap = $('<div/>',{
				class: "question-wrap"
			});
			question_2_wrap.append("<p> 2. " + all_questions[user_state.element.name]["question_2"]["question_wording"] + "</p>");

			var question_3_wrap = $('<div/>',{
				class: "question-wrap"
			});
			question_3_wrap.append("<p> 3. " + all_questions[user_state.element.name]["question_3"]["question_wording"] + "</p>");

			all_questions[user_state.element.name]["question_1"]["answer_choices"].forEach(function(element, index) {
				var question_1_input_wrap = $('<div/>', {
					class: "question-input-wrap",
				});
				var question_1_input = $("<input/>", {
					type: "radio",
					name: "step_3_2_question_1",
					value: element["let"]
				});
				question_1_input_wrap.append(question_1_input);
				question_1_input_wrap.append(element["text"]);
				question_1_wrap.append(question_1_input_wrap);

				question_1_input_wrap.click(function(e) {
					$(".question-input-wrap", question_1_wrap).removeClass("incorrect-answer").removeClass("correct-answer");
					$('input', $(e.delegateTarget)).prop('checked', true);
					var val = $("input[name='step_3_2_question_1']:checked").val();
					user_state.step_3_2.answer.question_1 = val;
					answer.setJSON({answer: user_state});
					if(user_state.step_3_2.answer.question_1.length != 0){
						if(user_state.step_3_2.answer.question_2.length != 0){
							if(user_state.step_3_2.answer.question_3.length != 0){
								enableSubmitButton();
							}
						}
					}
				});
			});

			all_questions[user_state.element.name]["question_2"]["answer_choices"].forEach(function(element, index) {
				var question_2_input_wrap = $('<div/>', {
					class: "question-input-wrap",
				});
				var question_2_input = $("<input/>", {
					type: "radio",
					name: "step_3_2_question_2",
					value: element["let"]
				});
				question_2_input_wrap.append(question_2_input);
				question_2_input_wrap.append(element["text"]);
				question_2_wrap.append(question_2_input_wrap)

				question_2_input_wrap.click(function(e) {
					$(".question-input-wrap", question_2_wrap).removeClass("incorrect-answer").removeClass("correct-answer");

					$('input', $(e.delegateTarget)).prop('checked', true);

					var val = $("input[name='step_3_2_question_2']:checked").val();
					user_state.step_3_2.answer.question_2 = val;
					answer.setJSON({answer: user_state});

					if(user_state.step_3_2.answer.question_1.length != 0){
						if(user_state.step_3_2.answer.question_2.length != 0){
							if(user_state.step_3_2.answer.question_3.length != 0){
								enableSubmitButton();
							}
						}
					}
				});
			});

			all_questions[user_state.element.name]["question_3"]["answer_choices"].forEach(function(element, index) {
				var question_3_input_wrap = $('<div/>', {
					class: "question-input-wrap",
				});
				var question_3_input = $("<input/>", {
					type: "checkbox",
					name: "step_3_2_question_3",
					value: element["let"]
				});
				question_3_input_wrap.append(question_3_input);
				question_3_input_wrap.append(element["text"]);
				question_3_wrap.append(question_3_input_wrap);

				question_3_input_wrap.click(function(e) {
					// console.log($('input', $(e.delegateTarget)).is("input"));
					if(!$(e.target).is("input")) {$('input', $(e.delegateTarget)).attr("checked", !$('input', $(e.delegateTarget)).prop("checked"))}
					// ;

					// .prop('checked', true);
					$(".question-input-wrap", question_3_wrap).removeClass("incorrect-answer").removeClass("correct-answer");
					var ans = [];
					$("input[name=step_3_2_question_3]").each(function() {
						if($(this).prop('checked')){
							ans.push($(this).val())
						}
					})
					user_state.step_3_2.answer.question_3 = ans;
					answer.setJSON({answer: user_state});
					if(user_state.step_3_2.answer.question_1.length != 0){
						if(user_state.step_3_2.answer.question_2.length != 0){
							if(user_state.step_3_2.answer.question_3.length != 0){
								enableSubmitButton();
							}
						}
					}
				});
			});

			questions_wrap.append(question_1_wrap);
			questions_wrap.append(question_2_wrap);
			questions_wrap.append(question_3_wrap);

			$("#visual_organizer_task").append(questions_wrap);
			$("#visual_organizer_task").append('<div class="used-attemps">Использовано попыток ' + user_state.step_3_2.attemps + " из " + max_step_3_2_attemps + "</div>");

			if (user_state.response["step_3_2"]){
				var selected_input_1 = $("input[value=" + user_state.step_3_2.answer.question_1 + "]" , question_1_wrap);
				var selected_input_2 = $("input[value=" + user_state.step_3_2.answer.question_2 + "]" , question_2_wrap);
				$(selected_input_1).prop('checked', true);
				$(selected_input_2).prop('checked', true);
				user_state.step_3_2.answer.question_3.forEach(function(element, index) {
					var selected_input_3 = $("input[value=" + element + "]" , question_3_wrap);
					$(selected_input_3).prop('checked', true);
				})
				enableSubmitButton();
				if(user_state.step_3_2.attemps == max_step_3_2_attemps){

					if(!user_state.response["step_3_2"]["question_1"]["correctness"] || !user_state.response["step_3_2"]["question_2"]["correctness"] || !user_state.response["step_3_2"]["question_3"]["correctness"]){
						var correct_answer = $("<div/>",{
							class: "highligth-correct-answer",
						});
						correct_answer.append("<h2>Правильный ответ:</h2>");
						correct_answer.append("<p><strong>1. " + all_questions[user_state.element.name].question_1.question_wording +"</strong> <span>" + all_questions[user_state.element.name].question_1.answer_choices.filter(function(item){return item["let"]==user_state.response.step_3_2.question_1.correct_answer})[0].text + "</span></p>");
						correct_answer.append("<p><strong>2. " + all_questions[user_state.element.name].question_2.question_wording +"</strong> <span>" + all_questions[user_state.element.name].question_2.answer_choices.filter(function(item){return item["let"]==user_state.response.step_3_2.question_2.correct_answer})[0].text + "</span></p>");
						var question_3_answer ="<p><strong>3. " + all_questions[user_state.element.name].question_3.question_wording +"</strong></p><ul>";
						all_questions[user_state.element.name].question_3.answer_choices.filter(function(item){return user_state.response.step_3_2.question_3.correct_answer.includes(item["let"])}).forEach(function(elem, index){ question_3_answer+="<li>" + elem.text + "</li>" });
						question_3_answer +="</ul>";
						correct_answer.append(question_3_answer);
						$("#visual_organizer_task").append(correct_answer);
					}
					$(submit_button).hide();
					$("#vizual_organizer_explanation").show();
					$(".question-input-wrap input", questions_wrap).prop('disabled', true);
					$(".question-input-wrap", questions_wrap).unbind( "click" )
					$(".question-input-wrap", questions_wrap).css('cursor', 'not-allowed');
					// All attempts used. Show correct answer
				}
				else{
					user_state.step_3_2.attemps += 1;
				}

				if (user_state.response["step_3_2"]["question_1"]["correctness"] == true){
					selected_input_1.closest('.question-input-wrap').addClass("correct-answer");
				}
				else{
					selected_input_1.closest('.question-input-wrap').addClass("incorrect-answer");
				}

				if (user_state.response["step_3_2"]["question_2"]["correctness"] == true){
					selected_input_2.closest('.question-input-wrap').addClass("correct-answer");
				}
				else{
					selected_input_2.closest('.question-input-wrap').addClass("incorrect-answer");
				}

				if (user_state.response["step_3_2"]["question_3"]["correctness"] == true){
					user_state.step_3_2.answer.question_3.forEach(function(element, index) {
						var selected_input_3 = $("input[value=" + element + "]" , question_3_wrap);
						selected_input_3.closest('.question-input-wrap').addClass("correct-answer");
					});
				}
				else{
					user_state.step_3_2.answer.question_3.forEach(function(element, index) {
						var selected_input_3 = $("input[value=" + element + "]" , question_3_wrap);
						if (user_state.response.step_3_2.question_3.user_correct.includes(element)){
							selected_input_3.closest('.question-input-wrap').addClass("correct-answer");
						}
						else{
							selected_input_3.closest('.question-input-wrap').addClass("incorrect-answer");
						}
					});
				}

				if (user_state.response["step_3_2"]["question_1"]["correctness"] == true){
					if (user_state.response["step_3_2"]["question_2"]["correctness"] == true){
						if (user_state.response["step_3_2"]["question_3"]["correctness"] == true){
							$(submit_button).hide();
							$("#vizual_organizer_explanation").show();
							$(".question-input-wrap input", questions_wrap).prop('disabled', true);
							$(".question-input-wrap", questions_wrap).unbind( "click" )
							$(".question-input-wrap", questions_wrap).css('cursor', 'not-allowed');
						}
					}
				}


				//     setSubmitText(next_btn_label);
				//     user_state.step = 4;
				//     $(".question-input-wrap input").prop('disabled', true);
				//     $(".question-input-wrap").unbind( "click" )
				//     $(".question-input-wrap").css('cursor', 'not-allowed');
				//     selected_input.closest('.question-input-wrap').addClass("correct-answer");
				//     // show correctness "True"
				// }
				// else{
				//     selected_input.closest('.question-input-wrap').addClass("incorrect-answer");
				//     // show correctness "False"
				// }
			}
			else{
				user_state.step_3_2.attemps += 1;
			}
			answer.setJSON({answer: user_state});



		}

	</script>

	<div id="visual_organizer">

		<div id="wording_task">
			<p>Прочтите мысленный эксперимент «Колесо фортуны», выберите из списка наиболее подходящий инструмент для анализа информации, структурируйте ее, предложите решение проблемы (из списка), опираясь на проделанную работу.</p>

			<h2>Мысленный эксперимент «Колесо фортуны»</h2>
			<p>Не будучи математиком, Мардж вдруг поняла, что изобрела надежную систему обогащения при игре в рулетку.</p>
			<p>В течение нескольких дней, приходя в казино, она наблюдала за вращением барабана. Ей удалось заметить, что на удивление часто шарик выпадал либо только на черное, либо только на красное. Однако пять раз подряд на один цвет он выпадал редко, а шесть раз подряд лишь пару раз в день.</p>
			<p>На этом и должна была основываться ее система. Шансы на то, что шарик выпадет шесть раз подряд на поле одного цвета, были мизерными. Поэтому Мардж решила, что она будет наблюдать за игрой и, как только шарик выпадет пять раз подряд на красное, она сможет с уверенностью поставить на черное. Она должна будет выигрывать чаще, чем проигрывать, потому что шесть раз подряд на поле одного цвета шарик выпадал крайне редко. Она настолько уверилась в этом, что уже начала подумывать о том, как ей потратить выигранные деньги.</p>

		</div>

		<div id="visual_organizer_task">


		</div>

		<div id="vizual_organizer_explanation">
			<h2>Пояснение к эксперименту: </h2>
			<p>Ошибка Мардж представляет собой предупреждение против всяких ограничений в мысленных эксперимента. Если ее система кажется надежной, то это происходит потому, что она уже испытала ее и система сработала. Сработала в ее голове. Если игрока можно так легко увести в сторону представлением о том, что случится в гипотетической ситуации, то так же легко можно увести в сторону и философа.</p>
			<p>Однако ее ошибка связана с мышлением и не вызвана каким-то сбоем в реальном мире, подстраиваемом под интеллект. Эта ошибка заключается в том, что она перепугала вероятность того, что шарик выпадет шесть раз подряд на один и тот же цвет, и вероятность того, что шарик выпадет на поле того же цвета, после того как он выпал на него уже пять раз подряд.</p>
			<p>Представьте себе, к примеру, любую азартную игру, в которой люди соревнуются друг с другом, подбрасывая монетку. В первом раунде участвуют шестьдесят четыре человека, во втором — тридцать два, в третьем — шестнадцать и так далее, до тех пор пока в финале не останется всего двое. В начале состязаний шансы на выигрыш у любого участника составляют 64: 1. Но к моменту финала каждый из оставшихся участников имеет шансы на выигрыш из расчета 50–50. Однако, по логике Мардж, такие ставки имеются уже в первом раунде. И поэтому в финале, несмотря на то что там остается всего два человека, Мардж посчитала бы, что каждый из них имеет шанс на выигрыш из расчета 64:1. И это, конечно, означает, что каждый участник может выиграть в 1 из 32 двух случаев!</p>
			<p>Возвращаясь к рулетке, можно сказать, что и в самом деле маловероятно, чтобы шарик выпал шесть раз подряд на поле одинакового цвета, так же, как маловероятно (64: 1), что любой участник может выиграть соревнования по подбрасыванию монетки. Но, как только шарик выпадет пять раз на поле одного цвета, первоначальная невероятность выпадения шарика в шестой раз уже не важна: при следующем вращении рулетки шансы на то, что шарик выпадет либо на красное, либо на черное поле, составляют немногим меньше, чем 50–50 (а ведь на рулетке (барабане) есть еще два зеленых поля).</p>
			<p>Смысл этой истории заключается в том, что невозможность того, что случилось в прошлом, не влияет на вероятность того, что еще должно случиться. Мардж должна была видеть это. Если бы она обратила внимание на то, как часто серия из пяти попаданий шарика на поле одного цвета превращается в серию из шести попаданий, она бы увидела, что в действительности, шансы на это составляли немногим меньше, чем 50–50. Таким образом, ее ошибка заключалась не в ошибочных рассуждениях, а в том, что она посчитала реальным то, что не было подтверждено ее наблюдениями. Она является плохим экспериментатором как в своих мыслях, так и наяву.</p>
		</div>


		<div id="visual_organizer_task_input">
			<customresponse cfn="check_answer">
				<textline size="40" value="$unique_id" />
			</customresponse>
		</div>

	</div>


</problem>
