<problem>

    <script type="loncapa/python">
more_sign = ">"
def check_answer(expect, ans):
    return 1

    </script>

    <style type="text/css">

        .answer-table td {
            border: 1px solid;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #c8c8c8;
            font-size: 14px;
        }

        .answer-table th {
            background: white;
        }

        .radio-td {
            text-align: center;
            position: relative;
            height: 30px;
        }

        .title-td {
            padding: 6px !important;

        }

        .radio-label {
            margin-bottom: 0px;
            margin-top: 0px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radio-label input {
            width: 15px !important;
            height: 15px !important;
        }

        .radio-input:hover {
            cursor: pointer;
        }

        .answer-table tr:hover {
            background: #d5f0fd;
        }

        th.heading-td {
            position: sticky;
            top: 0;
            z-index: 10;
            width: 80px !important;
            text-align: center !important;

            margin: 20px 0 !important;
            padding: 10px !important;
            border: 1px solid #c8c8c8;
            /*font-size: 14px;*/
            background: #eee !important;
        }
        span.submit-label {
            text-transform: initial !important;
        }

    </style>

    <script type="text/javascript">
        $(document).ready(function () {

            let answer = new Answer(document.querySelector("#temperament_diagnostic_input").querySelector("input[type='text']"));

            function clearProblemSigns(element) {
                let problemXBlock = $(element).closest('.xblock');
                $(".problem-progress", problemXBlock).hide();
                $(".button.submit", problemXBlock).hide();
                $(".notification", problemXBlock).hide();
                $(".problem-action-buttons-wrapper", problemXBlock).hide();
            }

            function Answer(elementField) {
                this.elementField = elementField;
                this.fieldValue = "";
                this.fieldObject = {};
                this.get = function () {
                    this.fieldValue = elementField.value;
                    return this.fieldValue;
                };
                this.set = function (value) {
                    if (value == undefined) value = this.fieldValue;
                    elementField.value = value;
                };
                this.getJSON = function () {
                    if (this.isJsonString(this.get())) this.fieldObject = JSON.parse(this.get());
                    return this.fieldObject;
                };
                this.setJSON = function (object) {
                    if (object == undefined) object = this.fieldObject;
                    this.set(JSON.stringify(object))
                };
                this.isJsonString = function (str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                };
            };

            function reset_answer() {
                state.completed = false;
                answer.setJSON({answer: state});
            }

            let TemperamentDiagnostic = function (html_element) {

                let temperament_block = $("<div/>", {class: "temperament-block"}).appendTo(html_element);

                const questions = {
                    question_1: {
                        text: "Часто ли вы испытываете тягу к новым впечатлениям, к тому, чтобы отвлечься, испытать сильные ощущения?"
                    },
                    question_2: {
                        text: "Часто ли вы чувствуете, что нуждаетесь в друзьях, которые могут вас понять, ободрить, посочувствовать?"
                    },
                    question_3: {
                        text: "Считаете ли вы себя беззаботным человеком?"
                    },
                    question_4: {
                        text: "Очень ли трудно вам отказаться от своих намерений?"
                    },
                    question_5: {
                        text: "Обдумываете ли вы свои дела не спеша и предпочитаете ли подождать, прежде чем действовать?"
                    },
                    question_6: {
                        text: "Всегда ли вы сдерживаете свои обещания, даже если это вам невыгодно?"
                    },
                    question_7: {
                        text: "Часто ли у вас бывают спады и подъемы настроения?"
                    },
                    question_8: {
                        text: "Быстро ли вы обычно действуете и говорите?"
                    },
                    question_9: {
                        text: "Возникало ли у вас когда-нибудь чувство, что вы несчастны, хотя никакой серьезной причины для этого не было?"
                    },
                    question_10: {
                        text: " Верно ли, что на «спор» вы способны решиться на все?"
                    },
                    question_11: {
                        text: " Смущаетесь ли вы, когда хотите познакомиться с человеком противоположного пола, который вам симпатичен?"
                    },
                    question_12: {
                        text: "Бывает ли когда-нибудь, что, разозлившись, вы выходите из себя?"
                    },
                    question_13: {
                        text: "Часто ли бывает, что вы действуете необдуманно, под влиянием момента?"
                    },
                    question_14: {
                        text: "Часто ли вас беспокоит мысль о том, что вам не следовало что-либо делать или говорить?"
                    },
                    question_15: {
                        text: "Предпочитаете ли вы чтение книг встречам с людьми?"
                    },
                    question_16: {
                        text: "Верно ли, что вас легко задеть?"
                    },
                    question_17: {
                        text: "Любите ли вы часто бывать в компании?"
                    },
                    question_18: {
                        text: "Бывают ли у вас такие мысли, которыми вам бы не хотелось делиться с другими?"
                    },
                    question_19: {
                        text: "Верно ли, что иногда вы настолько полны энергии, что все горит в руках, а иногда чувствуете усталость?"
                    },
                    question_20: {
                        text: "Стараетесь ли вы ограничить круг своих знакомств небольшим числом самых близких друзей?"
                    },
                    question_21: {
                        text: "Много ли вы мечтаете?"
                    },
                    question_22: {
                        text: "Когда на вас кричат, отвечаете ли вы тем же?"
                    },
                    question_23: {
                        text: "Считаете ли вы все свои привычки хорошими?"
                    },
                    question_24: {
                        text: "Часто ли у вас появляется чувство, что вы в чем-то виноваты?"
                    },
                    question_25: {
                        text: "Способны ли вы иногда дать волю своим чувствам и беззаботно развлекаться в веселой компании?"
                    },
                    question_26: {
                        text: "Можно ли сказать, что нервы у вас часто бывают натянуты до предела?"
                    },
                    question_27: {
                        text: "Слывете ли вы человеком живым и веселым?"
                    },
                    question_28: {
                        text: "После того как дело сделано, часто ли вы мысленно возвращаетесь к нему и думаете, что смогли бы сделать лучше?"
                    },
                    question_29: {
                        text: "Чувствуете ли вы себя неспокойно, находясь в большой компании?"
                    },
                    question_30: {
                        text: "Бывает ли, что вы передаете слухи?"
                    },
                    question_31: {
                        text: "Бывает ли, что вам не спится из-за того, что в голову лезут разные мысли?"
                    },
                    question_32: {
                        text: "Если вы хотите что-то узнать, вы предпочитаете найти это в книге или спросить у людей?"
                    },
                    question_33: {
                        text: "Бывает ли у вас сильное сердцебиение?"
                    },
                    question_34: {
                        text: "Нравится ли вам работа, требующая сосредоточения?"
                    },
                    question_35: {
                        text: "Бывают ли у вас приступы дрожи?"
                    },
                    question_36: {
                        text: "Всегда ли вы говорите правду?"
                    },
                    question_37: {
                        text: "Бывает ли вам неприятно находиться в компании, где подшучивают друг над другом?"
                    },
                    question_38: {
                        text: "Раздражительны ли вы?"
                    },
                    question_39: {
                        text: "Нравится ли вам работа, требующая быстродействия?"
                    },
                    question_40: {
                        text: "Верно ли, что вам часто не дают покоя мысли о разных неприятностях и ужасах, которые могли бы произойти, хотя все закончилось благополучно?"
                    },
                    question_41: {
                        text: "Верно ли, что вы неторопливы в движениях и несколько медлительны?"
                    },
                    question_42: {
                        text: "Опаздываете ли вы когда-нибудь на работу или на встречу с кем-либо?"
                    },
                    question_43: {
                        text: "Часто ли вам снятся кошмары?"
                    },
                    question_44: {
                        text: "Верно ли, что вы так любите поговорить, что не упускаете любого случая побеседовать с новым человеком?"
                    },
                    question_45: {
                        text: "Беспокоят ли вас какие-нибудь боли?"
                    },
                    question_46: {
                        text: "Огорчились бы вы, если бы долго не могли видеться с друзьями?"
                    },
                    question_47: {
                        text: "Вы нервный человек?"
                    },
                    question_48: {
                        text: "Есть ли среди ваших знакомых те, которые явно вам не нравятся?"
                    },
                    question_49: {
                        text: "Вы уверенный в себе человек?"
                    },
                    question_50: {
                        text: "Легко ли вас задевает критика ваших недостатков или вашей работы?"
                    },
                    question_51: {
                        text: "Трудно ли вам получить настоящее удовольствие от мероприятий, в которых участвует много народу?"
                    },
                    question_52: {
                        text: "Беспокоит ли вас чувство, что вы чем-то хуже других?"
                    },
                    question_53: {
                        text: "Сумели бы вы внести оживление в скучную компанию?"
                    },
                    question_54: {
                        text: "Бывает ли, что вы говорите о вещах, в которых совсем не разбираетесь?"
                    },
                    question_55: {
                        text: "Беспокоитесь ли вы о своем здоровье?"
                    },
                    question_56: {
                        text: "Любите ли вы подшутить над другими?"
                    },
                    question_57: {
                        text: "Страдаете ли вы бессонницей?"
                    }
                }

                const answer_choices = {
                    y: {
                        text: "Да",
                        value: 1
                    },
                    n: {
                        text: "Нет",
                        value: 0
                    }
                };

                const types = {
                    extraversion: {
                        y: [1, 3, 8, 10, 13, 17, 22, 25, 27, 39, 44, 46, 49, 53, 56],
                        n: [5, 15, 20, 29, 32, 37, 41, 51]
                    },
                    neuroticism:{
                        y: [2, 4, 7, 9, 11, 14, 16, 19, 21, 23, 26, 28, 31, 33, 35, 38, 40, 43, 45, 47, 50, 52, 55, 57],
                        n: []
                    },
                    lying: {
                        y: [6, 24, 36],
                        n: [12, 18, 30, 42, 48, 54]
                    }
                };

                function calculate_result(){
                    let result = {
                        extraversion: 0,
                        neuroticism: 0,
                        lying: 0
                    };

                    Object.keys(state.result.user_answers).forEach(function (item, idx) {
                        let num_question = parseInt(item.replace("question_", ""));

                        if (Object.keys(answer_choices).includes(state.result.user_answers[item])) {
                            if(types.extraversion.y.includes(num_question)){
                                if (state.result.user_answers[item] === 'y'){
                                    result.extraversion += 1;
                                }
                            }
                            else if(types.extraversion.n.includes(num_question)){
                                if (state.result.user_answers[item] === 'n'){
                                    result.extraversion += 1;
                                }
                            }
                            if(types.neuroticism.y.includes(num_question)){
                                if (state.result.user_answers[item] === 'y'){
                                    result.neuroticism += 1;
                                }
                            }
                            else if(types.neuroticism.n.includes(num_question)){
                                if (state.result.user_answers[item] === 'n'){
                                    result.neuroticism += 1;
                                }
                            }
                            if(types.lying.y.includes(num_question)){
                                console.log(state.result.user_answers[item]);
                                if (state.result.user_answers[item] === 'y'){
                                    result.lying += 1;
                                }
                            }
                            else if(types.lying.n.includes(num_question)){
                                if (state.result.user_answers[item] === 'n'){
                                    result.lying += 1;
                                }
                            }
                            else{
                                // console.error("Undefined question.");
                            }
                        }
                        else{
                            // console.error("Undefined answer.");
                        }
                    });

                    return result;
                }

                function create_answer_block() {

                    let answer_table = $("<table/>", {
                        class: "answer-table"
                    });
                    state.result.calculated = {};

                    let thead = $("<thead/>").appendTo(answer_table);

                    var table_heading = $("<tr/>", {html: $("<th/>", {html: "Вопрос",class: "heading-td" } )}).appendTo(thead);

                    Object.keys(answer_choices).forEach(function (item) {
                        table_heading.append($("<th/>", {html: answer_choices[item].text, class: "heading-td"}));
                    });

                    let tbody = $("<tbody/>",{});
                    answer_table.append(tbody);



                    Object.keys(questions).forEach(function (item) {

                        let question_num = item.replace("question_", "");
                        state.result.user_answers[item] = "";

                        var table_tr = $("<tr/>", {});
                        var table_td = $("<td/>", {html:question_num + ". " + questions[item].text, class: "title-td"});
                        table_tr.append(table_td);

                        Object.keys(answer_choices).forEach(function (choice, index) {
                            let radio_label = $("<label/>", {
                                class: "radio-label",
                            });
                            let radio_input = $("<input/>", {
                                type: "radio",
                                class: "radio-input",
                                value: choice,
                                name: item
                            });

                            radio_label.prepend(radio_input);
                            let choice_td = $("<td/>", {class: "radio-td", html: radio_label});
                            table_tr.append(choice_td);
                        });
                        answer_table.append(table_tr)
                    });

                    $(temperament_block).append(answer_table);


                    $(".answer-table .radio-input").change(function () {
                        state.result.user_answers[this.name] = this.value;
                        if (Object.keys(state.result.user_answers).map(function (item) {
                            return state.result.user_answers[item]
                        }).every(function (element) {
                            return element.length != 0
                        })) {
                            submit_button.removeAttr("disabled");
                            state.completed = true;
                        }
                        state.result.calculated = calculate_result();

                        console.log(state);
                        answer.setJSON({answer: state});
                    });

                }

                function create_result_block() {
                    temperament_block.append($("<h2/>", {html: "Расшифровка"}));
                    // temperament_block.append($("<div/>", {}));
                    temperament_block.append("<p>" + "Экстраверсия: " + state.result.calculated.extraversion + "</p>");
                    temperament_block.append("<p>" + "Нейротизм: " + state.result.calculated.neuroticism + "</p>");
                    temperament_block.append("<p>" + "Ложь: " + state.result.calculated.lying + "</p>");
                }

                this.create_answer_block = create_answer_block;
                this.create_result_block = create_result_block;

            };

            let state = {
                completed: false,
                result: {
                    calculated: {},
                    user_answers: {},
                },
            };

            let temperament_diagnostic_block = document.getElementById("temperament_diagnostic_block");
            clearProblemSigns(temperament_diagnostic_block);

            let submit_button = $(temperament_diagnostic_block).closest(".problem").find('button.submit');
            submit_button.attr("disabled", "disabled");

            let temperament_diagnostic = new TemperamentDiagnostic(temperament_diagnostic_block);

            if (answer.get()) {
                state = answer.getJSON()["answer"];
                if(state.completed){
                    temperament_diagnostic.create_result_block();
                    $('span.submit-label', submit_button).html("Пройти еще раз");
                    submit_button.removeAttr("disabled");
                    reset_answer();
                }
                else{
                    temperament_diagnostic.create_answer_block()
                }
            }
            else{
            temperament_diagnostic.create_answer_block()
            }


        });
    </script>


    <div id="temperament_diagnostic_block"></div>
    <div id="temperament_diagnostic_input" style="display: none !important;">
        <customresponse cfn="check_answer">
            <textline/>
        </customresponse>
    </div>

<!--

В методике расчета не используется 34 вопрос - норма ли это?

-->


</problem>

