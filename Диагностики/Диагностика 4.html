<problem>
    <script type="loncapa/python">
more_sign = ">"
def check_answer(expect, ans):
    return 1


    </script>
    <style type="text/css">

        .question-block{
            margin: 10px 0px;
            padding: 10px;
            border-bottom: 2px solid #c7c7c9;
        }

        .radio-td {
            text-align: center !important;
            position: relative;
        }

        .heading-td {

            width: 70px !important;
            text-align: center !important;

            margin: 20px 0 !important;
            padding: 2px !important;
            border: 1px solid #c8c8c8;
            /*font-size: 14px;*/
            background: #eee !important;
        }

        .radio-label {
            margin-bottom: 0px;
            margin-top: 0px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radio-label input {
            width: 15px !important;
            height: 15px !important;
        }

        .radio-label:hover, .radio-input:hover {
            cursor: pointer;
        }


        .question-answer-table td {
            padding: 20px !important;
            border: 1px solid #c8c8c8;
            font-size: 14px;
        }

        span.submit-label {
            text-transform: initial !important;
        }

    </style>

    <script type="text/javascript">
        $(document).ready(function () {

            let answer = new Answer(document.querySelector("#role_positions_block_input").querySelector("input[type='text']"));

            function clearProblemSigns(element) {
                let problemXBlock = $(element).closest('.xblock');
                $(".problem-progress", problemXBlock).hide();
                $(".button.submit", problemXBlock).hide();
                $(".notification", problemXBlock).hide();
                $(".problem-action-buttons-wrapper", problemXBlock).hide();
            }

            function Answer(elementField) {
                this.elementField = elementField;
                this.fieldValue = "";
                this.fieldObject = {};
                this.get = function () {
                    this.fieldValue = elementField.value;
                    return this.fieldValue;
                };
                this.set = function (value) {
                    if (value == undefined) value = this.fieldValue;
                    elementField.value = value;
                };
                this.getJSON = function () {
                    if (this.isJsonString(this.get())) this.fieldObject = JSON.parse(this.get());
                    return this.fieldObject;
                };
                this.setJSON = function (object) {
                    if (object == undefined) object = this.fieldObject;
                    this.set(JSON.stringify(object))
                };
                this.isJsonString = function (str) {
                    try {
                        JSON.parse(str);
                    } catch (e) {
                        return false;
                    }
                    return true;
                };
            };

            function reset_answer() {
                state.completed = false;
                answer.setJSON({answer: state});
            }

            let RolePositionsDiagnostic = function (html_element) {
                let role_positions_block = $("<div/>", {class: "role-positions-block"}).appendTo(html_element);

                const questions = {
                    question_1:
                        {
                            text: "Мне порой не хватает выдержки."
                        },
                    question_2:
                        {
                            text: "Если мои желания мешают мне, то я умею их подавлять."
                        },
                    question_3:
                        {
                            text: "Родители как более взрослые люди должны устраивать семейную жизнь сво­их детей."
                        },
                    question_4:
                        {
                            text: "Я иногда преувеличиваю свою роль в каких-либо событиях."
                        },
                    question_5:
                        {
                            text: "Меня провести нелегко."
                        },
                    question_6:
                        {
                            text: "Мне бы понравилось быть воспитателем."
                        },
                    question_7:
                        {
                            text: "Бывает, мне хочется подурачиться, как маленькому."
                        },
                    question_8:
                        {
                            text: "Думаю, что правильно понимаю все происходящие события."
                        },
                    question_9:
                        {
                            text: "Каждый должен выполнять свой долг."
                        },
                    question_10:
                        {
                            text: "Нередко я поступаю не как надо, а как хочется."
                        },
                    question_11:
                        {
                            text: "Принимая решение, я стараюсь продумать его последствия."
                        },
                    question_12:
                        {
                            text: "Младшее поколение должно учиться у старших, как ему следует жить."
                        },
                    question_13:
                        {
                            text: "Я, как и многие люди, бываю обидчив."
                        },
                    question_14:
                        {
                            text: "Мне удается видеть в людях больше, чем они говорят о себе."
                        },
                    question_15:
                        {
                            text: "Дети должны безусловно следовать указаниям родителей."
                        },
                    question_16:
                        {
                            text: "Я — увлекающийся человек."
                        },
                    question_17:
                        {
                            text: "Мой основной критерий оценки человека — объективность."
                        },
                    question_18:
                        {
                            text: "Мои взгляды непоколебимы."
                        },
                    question_19:
                        {
                            text: "Бывает, что я не уступаю в споре лишь потому, что не хочу уступать."
                        },
                    question_20:
                        {
                            text: "Правила оправданны лишь до тех пор, пока они полезны."
                        },
                    question_21:
                        {
                            text: "Люди должны соблюдать все правила независимо от обстоятельств."
                        }
                }
                const answer_choices = {
                    a: {
                        text: "0",
                        value: 0
                    },
                    b: {
                        text: "1",
                        value: 1
                    },
                    c: {
                        text: "2",
                        value: 2
                    },
                    d: {
                        text: "3",
                        value: 3
                    },
                    e: {
                        text: "4",
                        value: 4
                    },
                    f: {
                        text: "5",
                        value: 5
                    },
                    g: {
                        text: "6",
                        value: 6
                    },
                    h: {
                        text: "7",
                        value: 7
                    },
                    i: {
                        text: "8",
                        value: 8
                    },
                    j: {
                        text: "9",
                        value: 9
                    },
                    k: {
                        text: "10",
                        value: 10
                    }
                };
                const types = {
                    child: {
                        values: [1, 4, 7, 10, 13, 16, 19],
                        text: "<p><em>Детское состояние Я</em> следует жизненному принципу чувств. На поведение в настоящем влияют чувства из детства. Детское Я также выполняет свои, особые функции, не свойственные двум другим составляющими личности. Оно ''отвечает'' за творчество, оригинальность, разрядку напряжения, получение приятных, иногда ''острых'', необходимых в определенной степени для нормальной жизнедеятельности впечатлений. Кроме того, Детское Я выступает на сцену, когда человек не чувствует достаточно сил для самостоятельного решения проблем: не способен преодолеть трудности или/и противостоять давлению другого человека. Это Я подразделяется на: естественное детское Я (спонтанные реакции типа радости, печали и т.д.), приспосабливающееся детское Я (приспосабливающийся, прислуживающийся, боязливый, виноватый, колеблющийся и т.п.), возражающее детское Я.</p>"
                    },
                    adult: {
                        values: [2, 5, 8, 11, 14, 17, 20],
                        text: "<p><em>Взрослое состояние Я</em> воспринимает и перерабатывает логическую составляющую информации, принимает решения преимущественно обдуманно и без эмоций, проверяя их реальность. Взрослое Я, в отличии от Родительского, способствует адаптации не в стандартных, однозначных ситуациях, а уникальных, требующих размышлений, дающих свободу выбора и, вместе с этим, необходимость осознания последствий и ответственного принятия решений.</p>"
                    },
                    parent: {
                        values: [3, 6, 9, 12, 15, 18, 21],
                        text: "<p><em>Родительское состояние Я</em> подразделяется на заботливое родительское состояние Я, критическое родительское состояние Я. Родительское Я, состоящее из правил поведения, норм, позволяет индивиду успешно ориентироваться в стандартных ситуациях, «запускает» полезные, проверенные стереотипы поведения, освобождая сознание от загруженности простыми, обыденными задачами. Кроме того, Родительское Я обеспечивает с большой вероятностью успеха поведение в ситуациях дефицита времени на размышления, анализ, поочередное рассмотрение возможностей поведения.</p>"
                    }
                };

                function calculate_result() {
                    let result = {
                        child: 0,
                        adult: 0,
                        parent: 0
                    };

                    Object.keys(state.result.user_answers).forEach(function (item, idx) {
                        let num_question = parseInt(item.replace("question_", ""));
                        console.log("num_question: ", num_question );
                        if(answer_choices[state.result.user_answers[item]]){
                            if (types.child.values.includes(num_question)){
                                result.child += answer_choices[state.result.user_answers[item]].value;
                            }else if (types.adult.values.includes(num_question)){
                                result.adult += answer_choices[state.result.user_answers[item]].value;
                            }else if (types.parent.values.includes(num_question)){
                                result.parent += answer_choices[state.result.user_answers[item]].value;
                            }else{
                                // console.log("Undefined question");
                            }
                        }
                        else{
                            // console.log("Undefined/empty answer field");
                        }

                    });
                    return result;
                }


                function create_answer_block() {

                    let task_text = `
                        <p>Основоположником трансактного (транзактного) анализа общения является Эрик Берн.</p>
                    <p>Теория трансактного анализа Э. Берна исходит из того, что транзакция — единица акта общения, в течение которой собеседники находятся в одном из трех состояний ''Я".</p>
                    <p>В процессе взаимодействия могут в большей или меньшей мере проявляться такие состояния человека: состояние "родителя", "взрослого", "ребенка". Эти три состояния сопровождают человека всю жизнь.</p>
                    <p>Зрелый человек умело использует разные формы поведения, гибко проявляя себя в том или ином состоянии в зависимости от его целей и жизненных обстоятельств.</p>
                    <p><em>Инструкция к тесту: </em></p>
                    <p>Попробуйте оценить, как сочетаются эти три "Я" в вашем поведении. Для этого оцените приведенные высказывания в баллах от 0 до 10.</p>
                    `

                    role_positions_block.append(task_text);

                    state.result.calculated = {};

                    Object.keys(questions).forEach(function (item) {
                        let question_num = item.replace("question_", "");
                        let question_block = $("<div/>", {class: "question-block", });
                        let question_title_block = $("<div/>", {class: "question-title-block", html: "<strong>" + question_num + ". </strong>" + questions[item].text});

                        let question_answer_table = $("<table/>", {class: "question-answer-table" });

                        let question_answer_table_head = $("<tr/>", { });
                        let question_answer_table_input = $("<tr/>", { });

                        state.result.user_answers[item] = "";

                        Object.keys(answer_choices).forEach(function (answer) {
                            let head_td = $("<th/>", {class: "heading-td", html: answer_choices[answer].text});
                            question_answer_table_head.append(head_td);

                            let answer_td = $("<td/>", {class: "radio-td"});

                            let radio_label = $("<label/>", {
                                class: "radio-label",
                            });
                            let radio_input = $("<input/>", {
                                type: "radio",
                                class: "radio-input",
                                value: answer,
                                name: item
                            });

                            radio_label.prepend(radio_input);

                            answer_td.append(radio_label);

                            question_answer_table_input.append(answer_td);

                        });

                        question_answer_table.append(question_answer_table_head);
                        question_answer_table.append(question_answer_table_input);

                        question_block.append(question_title_block);
                        question_block.append(question_answer_table);

                        role_positions_block.append(question_block);

                        answer.setJSON({answer: state});
                    });

                    $(".radio-input", role_positions_block).change(function () {
                        state.result.user_answers[this.name] = this.value;
                        if (Object.keys(state.result.user_answers).map(function (item) {
                            return state.result.user_answers[item]
                        }).every(function (element) {
                            return element.length != 0
                        })) {
                            submit_button.removeAttr("disabled");
                            state.completed = true;
                        }
                        else{
                            submit_button.attr("disabled", "disabled");
                        }
                        // else{
                        //         console.log(Object.keys(state.result.user_answers).filter(function (item) {return state.result.user_answers[item] == ""}));
                        // }
                        state.result.calculated = calculate_result();
                        answer.setJSON({answer: state});

                    });
                }

                function create_result_block() {
                    role_positions_block.append($("<h2/>", {html: "Расшифровка"}));

                    let result_array = Object.keys(state.result.calculated).map(function (item) {return {'name': item, 'value': state.result.calculated[item]}});
                    let max_points = Math.max.apply(Math, result_array.map(function(item){return item.value}));
                    let user_types = result_array.filter(function (item) { return item.value == max_points;});

                    user_types.forEach(function (item) {
                        role_positions_block.append($("<p/>", {html: types[item.name].text}));
                    });

                    console.log(user_types);

                }


                this.create_answer_block = create_answer_block;
                this.create_result_block = create_result_block;

            };

            let state = {
                completed: false,
                result: {
                    calculated: {},
                    user_answers: {},
                },
            };

            let role_positions_block = document.getElementById("role_positions_block");
            clearProblemSigns(role_positions_block);

            let submit_button = $(role_positions_block).closest(".problem").find('button.submit');
            submit_button.attr("disabled", "disabled");

            let role_positions_diagnostic = new RolePositionsDiagnostic(role_positions_block);

            if (answer.get()) {
                state = answer.getJSON()["answer"];
                if(state.completed){
                    role_positions_diagnostic.create_result_block();
                    $('span.submit-label', submit_button).html("Пройти еще раз");
                    submit_button.removeAttr("disabled");
                    reset_answer();
                }
                else{
                    role_positions_diagnostic.create_answer_block()
                }
            }
            else{
            role_positions_diagnostic.create_answer_block()
            }

        });
    </script>


    <div id="role_positions_block"></div>
    <div id="role_positions_block_input" style="display: none !important;">
        <customresponse cfn="check_answer">
            <textline/>
        </customresponse>
    </div>
</problem>
